# =============================================================================
# ðŸ“‹ Document Role: This is a DERIVATIVE of IMPL-TEMPLATE.md
# - Authority: IMPL-TEMPLATE.md is the single source of truth for IMPL structure
# - Purpose: Machine-readable validation rules derived from the template
# - On conflict: Defer to IMPL-TEMPLATE.md
# =============================================================================
#
# IMPL Schema Definition v1.1
# Purpose: Define valid metadata structure and validation rules for IMPL documents
# Usage: Reference by validate_impl.py for automated validation

schema_version: "1.1"
artifact_type: IMPL
layer: 8
last_updated: "2026-01-13"

references:
  template: "IMPL-TEMPLATE.md"
  creation_rules: "IMPL_CREATION_RULES.md"
  validation_rules: "IMPL_VALIDATION_RULES.md"

# =============================================================================
# YAML Frontmatter Requirements
# =============================================================================

metadata:
  # Required fields in custom_fields
  required_custom_fields:
    document_type:
      type: string
      required: true
      allowed_values: ["impl", "template"]
      description: "Must be 'impl' for documents, 'template' for templates"

    artifact_type:
      type: string
      required: true
      allowed_values: ["IMPL"]
      description: "Must be uppercase 'IMPL'"

    layer:
      type: integer
      required: true
      allowed_values: [8]
      description: "IMPL is always Layer 8 artifact (Project Management Layer)"

    architecture_approaches:
      type: array
      required: true
      allowed_values:
        - ["ai-agent-based"]
        - ["traditional-8layer"]
        - ["ai-agent-based", "traditional-8layer"]
      description: "Must be array format, not 'architecture_approach' string"

    priority:
      type: string
      required: true
      allowed_values: ["primary", "shared", "fallback"]
      description: "Classification tier based on architecture"

    development_status:
      type: string
      required: true
      allowed_values: ["active", "draft", "deprecated", "reference"]
      description: "Current development status"

  # Optional custom_fields
  optional_custom_fields:
    template_for:
      type: string
      description: "For template files only - describes template purpose"

    schema_reference:
      type: string
      pattern: "^IMPL_SCHEMA\\.yaml$"
      description: "Reference to validation schema"

    schema_version:
      type: string
      pattern: "^\\d+\\.\\d+$"
      description: "Version of schema this document conforms to"

  # Required tags
  required_tags:
    - impl                # Primary identifier - REQUIRED
    - layer-8-artifact    # Layer identifier - REQUIRED

  # Forbidden tag patterns (will fail validation)
  forbidden_tag_patterns:
    - "^implementation-plan$"       # Use 'impl' instead
    - "^implementation_plan$"       # Use 'impl' instead
    - "^project-plan$"              # Use 'impl' instead
    - "^impl-\\d{2,}$"              # Don't include document number in tags

# =============================================================================
# Document Structure Requirements
# =============================================================================

structure:
  # Required sections (based on IMPL-TEMPLATE.md 4-part structure)
  # Updated 2026-01-13 to match new sequential numbering with Part labels
  required_sections:
    - pattern: "^# IMPL-\\d{2,}:"
      name: "Title (H1)"
      description: "Single H1 with format IMPL-NN: Title"

    - pattern: "^## 1\\. Document Control$"
      name: "Document Control"
      description: "Section 1 with metadata table"

    - pattern: "^## 2\\. Position in Document Workflow$"
      name: "Position in Document Workflow"
      description: "Section 2 with workflow diagram and scope distinction"

    - pattern: "^## 3\\. Project Context and Strategy \\(PART 1\\)$"
      name: "Part 1: Project Context"
      description: "Section 3 with overview, objectives, scope, dependencies"

    - pattern: "^## 4\\. Phased Implementation \\(PART 2\\)$"
      name: "Part 2: Implementation Phases"
      description: "Section 4 with phase definitions using IMPL.NN.29.SS IDs"

    - pattern: "^## 5\\. Project Management and Risk \\(PART 3\\)$"
      name: "Part 3: Project Management"
      description: "Section 5 with resources, risk register, communication, escalation"

    - pattern: "^## 6\\. Tracking and Completion \\(PART 4\\)$"
      name: "Part 4: Tracking"
      description: "Section 6 with deliverables, validation, operational acceptance, completion criteria"

    - pattern: "^## 7\\. Traceability$"
      name: "Traceability"
      description: "Section 7 with upstream/downstream references and cumulative tags"

    - pattern: "^## 8\\. References$"
      name: "References"
      description: "Section 8 with internal and template links"

    - pattern: "^## 9\\. Template Instructions$"
      name: "Template Instructions"
      description: "Section 9 with usage guidance (template files only)"
      optional: true

  # Document Control table requirements
  document_control:
    required_fields:
      - IMPL ID
      - Title
      - Status
      - Created
      - Author
      - Owner
      - Last Updated
      - Version
      - Related REQs
      - Deliverables

    status_values:
      - "Draft"
      - "Planned"
      - "In Progress"
      - "On Hold"
      - "Completed"
      - "Cancelled"

    impl_id_format:
      pattern: "^IMPL-\\d{2,}$"
      description: "Format: IMPL-NN"

    related_reqs_format:
      pattern: "REQ-\\d{2,}"
      description: "Must reference at least one REQ document"

    deliverables_format:
      pattern: "(CTR|SPEC|TASKS)-\\d{2,}"
      description: "Must list downstream deliverables (CTR, SPEC, TASKS)"

  # Section numbering rules
  section_numbering:
    start: 1
    format: "## N. Section Title"
    subsection_format: "### N.N Subsection Title"
    no_duplicate_numbers: true

# =============================================================================
# Phase Definition Patterns
# =============================================================================

phase_patterns:
  # Phase section format - Updated 2026-01-13 for element ID format
  phase_section:
    pattern: "^### IMPL\\.\\d{2,}\\.29\\.\\d{2,}:"
    description: "Phase subsection using element ID format: IMPL.NN.29.SS"
    element_type_code: 29
    element_type_name: "Implementation Phase"
    examples:
      - "### IMPL.01.29.01: Phase 1 - [Phase Name]"
      - "### IMPL.01.29.02: Phase 2 - [Phase Name]"
      - "### IMPL.02.29.03: Phase 3 - [Phase Name]"

  # Legacy format (deprecated - validation will warn)
  legacy_phase_section:
    pattern: "^### \\d+\\.\\d+ Phase \\d+:"
    description: "Deprecated - use element ID format instead"
    severity: warning

  # Phase table structure
  phase_table:
    required_fields:
      - Purpose
      - Owner
      - Timeline
      - Deliverables
      - Dependencies
      - Success Criteria

    deliverables_format:
      pattern: "(CTR|SPEC|TASKS)-\\d{1,3}"
      description: "Must reference downstream artifacts"

# =============================================================================
# Risk Register Patterns
# =============================================================================

risk_patterns:
  risk_id:
    pattern: "^R-\\d{2,}$"
    format: "R-NN+"
    description: "Risk identifier format (starts at 2 digits, expands as needed)"
    examples:
      - "R-01"
      - "R-15"
      - "R-100"

  risk_table:
    required_columns:
      - "Risk ID"
      - "Risk Description"
      - "Probability"
      - "Impact"
      - "Mitigation Strategy"
      - "Owner"
      - "Status"

    probability_values: ["Low", "Medium", "High"]
    impact_values: ["Low", "Medium", "High"]
    status_values: ["Open", "Mitigated", "Accepted", "Closed"]

# =============================================================================
# Validation Rules
# =============================================================================

validation_rules:
  # Metadata validation
  metadata:
    - rule: "document_type must be 'impl' or 'template'"
      severity: error

    - rule: "architecture_approaches must be array"
      severity: error
      fix: "Change 'architecture_approach: value' to 'architecture_approaches: [value]'"

    - rule: "tags must include 'impl' and 'layer-8-artifact'"
      severity: error

    - rule: "forbidden tag patterns must not appear"
      severity: error

  # Structure validation
  structure:
    - rule: "Single H1 heading only"
      severity: error

    - rule: "Document must have 4 PARTS (Part 1-4)"
      severity: error

    - rule: "Each phase must have Purpose, Owner, Timeline, Deliverables"
      severity: warning

    - rule: "No duplicate section numbers"
      severity: error

    - rule: "Sections must be numbered sequentially"
      severity: warning

  # Content validation
  content:
    - rule: "IMPL ID must use IMPL-NN format"
      severity: error

    - rule: "Related REQs must reference existing REQ documents"
      severity: warning

    - rule: "Deliverables must list CTR, SPEC, or TASKS documents"
      severity: warning

    - rule: "Risk IDs must use R-NNN format"
      severity: warning

    - rule: "Probability/Impact must be Low/Medium/High"
      severity: warning

  # Scope boundary validation
  scope:
    - rule: "IMPL must not contain technical HOW details (belongs in SPEC)"
      severity: warning
      check: "No code blocks or technical implementation details"

    - rule: "IMPL must not contain test details (belongs in 04_BDD/TASKS)"
      severity: warning

    - rule: "IMPL must focus on WHO, WHAT, WHEN, WHY"
      severity: info

# =============================================================================
# Cross-Reference Requirements (Layer 8)
# =============================================================================

traceability:
  # Cumulative tagging requirements for Layer 8
  cumulative_tags:
    layer: 8
    required:
      - "@brd: BRD.NN.EE.SS"
      - "@prd: PRD.NN.EE.SS"
      - "@ears: EARS.NN.EE.SS"
      - "@bdd: BDD.NN.EE.SS"
      - "@adr: ADR-NN"
      - "@sys: SYS.NN.EE.SS"
      - "@req: REQ.NN.EE.SS"
    description: "Layer 8 requires @brd, @prd, @ears, @bdd, @adr, @sys, @req tags for complete traceability"

  upstream:
    required:
      - type: REQ
        format: "@req: REQ.NN.EE.SS"
        location: "Document Control table and Traceability section"
    optional:
      - type: BRD
        format: "@brd: BRD.NN.EE.SS"
      - type: PRD
        format: "@prd: PRD.NN.EE.SS"
      - type: EARS
        format: "@ears: EARS.NN.EE.SS"
      - type: BDD
        format: "@bdd: BDD.NN.EE.SS"
      - type: ADR
        format: "@adr: ADR-NN"
      - type: SYS
        format: "@sys: SYS.NN.EE.SS"

  downstream:
    expected:
      - type: CTR
        format: "@ctr: CTR.NN.EE.SS"
        description: "API/Data Contracts"
      - type: SPEC
        format: "@spec: SPEC.NN.EE.SS"
        description: "Technical Specifications"
      - type: TASKS
        format: "@tasks: TASKS.NN.EE.SS"
        description: "Code Generation Plans"

  # Note: Implementation contracts are now embedded in TASKS Section 7-8

  lateral:
    format: "@impl: IMPL.NN.EE.SS"
    description: "Cross-reference to related IMPL documents"
    relationships:
      - "@related-impl: IMPL.NN.EE.SS"
      - "@depends-impl: IMPL.NN.EE.SS"

# =============================================================================
# Error Messages
# =============================================================================

error_messages:
  IMPL-E001: "Missing required tag 'impl'"
  IMPL-E002: "Missing required tag 'layer-8-artifact'"
  IMPL-E003: "Invalid document_type: must be 'impl' or 'template'"
  IMPL-E004: "Invalid architecture format: use 'architecture_approaches: [value]' array"
  IMPL-E005: "Forbidden tag pattern detected"
  IMPL-E006: "Missing required Document Control field"
  IMPL-E007: "Invalid IMPL ID format: must be IMPL-NN"
  IMPL-E008: "Multiple H1 headings detected"
  IMPL-E009: "Missing required PART section"
  IMPL-E010: "No Related REQs specified"
  IMPL-E011: "No Deliverables specified"
  IMPL-W001: "Risk ID not using R-NNN format"
  IMPL-W002: "Phase missing required fields"
  IMPL-W003: "Section numbering not sequential"
  IMPL-W004: "Technical implementation details found (belongs in SPEC)"
  IMPL-W005: "Missing cumulative traceability tags"
