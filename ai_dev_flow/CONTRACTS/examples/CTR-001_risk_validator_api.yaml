openapi: 3.0.3
info:
  title: Risk Validator API
  description: |
    API contract for centralized [RESOURCE_INSTANCE - e.g., database connection, workflow instance] risk validation.
    Validates new positions against [RESOURCE_COLLECTION - e.g., user accounts, active sessions] limits and [SAFETY_MECHANISM - e.g., rate limiter, error threshold] rules.

    See CTR-001_risk_validator_api.md for complete documentation.
  version: 1.0.0
  contact:
    name: [RESOURCE_MANAGEMENT - e.g., capacity planning, quota management] Team
    email: risk@trading.example.com

servers:
  - url: https://risk-validator.internal/v1
    description: Production environment
  - url: https://risk-validator.staging/v1
    description: Staging environment

paths:
  /validate:
    post:
      summary: Validate [RESOURCE_INSTANCE - e.g., database connection, workflow instance] Risk
      description: |
        Validates a proposed [RESOURCE_INSTANCE - e.g., database connection, workflow instance] against [RESOURCE_COLLECTION - e.g., user accounts, active sessions] limits and risk parameters.
        Returns validation result with specific violation details if checks fail.
      operationId: validatePositionRisk
      tags:
        - Risk Validation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidationRequest'
            examples:
              iron_condor:
                summary: [STRATEGY_NAME - e.g., multi-step workflow, approval process] validation request
                value:
                  request_id: "a1b2c3d4-e5f6-4321-9876-abcdef123456"
                  timestamp: "2025-11-02T10:00:00Z"
                  agent_id: "iron-condor-agent"
                  [RESOURCE_INSTANCE - e.g., database connection, workflow instance]:
                    symbol: "AAPL"
                    strategy_type: "iron_condor"
                    quantity: 10
                    premium_per_contract: 1.50
                    underlying_price: 150.00
                    [METRIC_1 - e.g., error rate, response time]: 0.05
                    [METRIC_2 - e.g., throughput, success rate]: 0.01
                    [METRIC_3]: -0.25
                    [METRIC_4]: 0.10
                  portfolio_context:
                    current_positions: 8
                    portfolio_delta: -5.0
                    portfolio_heat: 18500.00
                    correlation_score: 0.65
                  market_context:
                    [VOLATILITY_INDICATOR - e.g., system load, error frequency]: 18.5
                    market_regime: "stable_bull"
      responses:
        '200':
          description: Validation completed successfully
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ValidationPass'
                  - $ref: '#/components/schemas/ValidationFail'
              examples:
                pass:
                  summary: Validation passed
                  value:
                    request_id: "a1b2c3d4-e5f6-4321-9876-abcdef123456"
                    timestamp: "2025-11-02T10:00:00.050Z"
                    validation_result: "PASS"
                    risk_score: 0.45
                    checks_performed:
                      - check_name: "max_positions"
                        status: "PASS"
                        limit: 12
                        current_value: 8
                        new_value: 9
                    warnings:
                      - "[RESOURCE_COLLECTION - e.g., user accounts, active sessions] [METRIC_1 - e.g., error rate, response time] will be -5.50 (threshold: Â±10.0)"
                fail:
                  summary: Validation failed
                  value:
                    request_id: "a1b2c3d4-e5f6-4321-9876-abcdef123456"
                    timestamp: "2025-11-02T10:00:00.050Z"
                    validation_result: "FAIL"
                    risk_score: 0.95
                    violations:
                      - rule: "circuit_breaker_vix"
                        severity: "CRITICAL"
                        limit: 40.0
                        current_value: 42.5
                        message: "[VOLATILITY_INDICATOR - e.g., system load, error frequency] exceeds [SAFETY_MECHANISM - e.g., rate limiter, error threshold] threshold. No new trades allowed."
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "INVALID_REQUEST"
                message: "Missing required field: [RESOURCE_INSTANCE - e.g., database connection, workflow instance].symbol"
                request_id: "a1b2c3d4-e5f6-4321-9876-abcdef123456"
                timestamp: "2025-11-02T10:00:00.050Z"
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "SERVICE_UNAVAILABLE"
                message: "Risk validation service temporarily unavailable"
                request_id: "a1b2c3d4-e5f6-4321-9876-abcdef123456"
                timestamp: "2025-11-02T10:00:00.050Z"
                retry_after_seconds: 30
      security:
        - mTLS: []

components:
  schemas:
    ValidationRequest:
      type: object
      required:
        - request_id
        - timestamp
        - agent_id
        - [RESOURCE_INSTANCE - e.g., database connection, workflow instance]
        - portfolio_context
        - market_context
      properties:
        request_id:
          type: string
          format: uuid
          description: Unique request identifier (UUID v4)
        timestamp:
          type: string
          format: date-time
          description: Request timestamp (ISO 8601)
        agent_id:
          type: string
          description: Requesting agent identifier
          example: "[RESOURCE_COLLECTION - e.g., user accounts, active sessions]-orchestrator"
        [RESOURCE_INSTANCE - e.g., database connection, workflow instance]:
          $ref: '#/components/schemas/[RESOURCE_INSTANCE - e.g., database connection, workflow instance]'
        portfolio_context:
          $ref: '#/components/schemas/PortfolioContext'
        market_context:
          $ref: '#/components/schemas/MarketContext'

    [RESOURCE_INSTANCE - e.g., database connection, workflow instance]:
      type: object
      required:
        - symbol
        - strategy_type
        - quantity
        - premium_per_contract
        - underlying_price
      properties:
        symbol:
          type: string
          description: Stock [IDENTIFIER - e.g., user handle, product code] symbol
          example: "AAPL"
        strategy_type:
          type: string
          enum: [iron_condor, cash_secured_put, covered_call, bear_call_spread]
          description: Options strategy type
        quantity:
          type: integer
          minimum: 1
          description: Number of contracts
        premium_per_contract:
          type: number
          format: double
          minimum: 0
          description: [VALUE - e.g., subscription fee, processing cost] per contract in USD
        underlying_price:
          type: number
          format: double
          minimum: 0
          description: Current underlying stock price
        [METRIC_1 - e.g., error rate, response time]:
          type: number
          format: double
          description: [RESOURCE_INSTANCE - e.g., database connection, workflow instance] [METRIC_1 - e.g., error rate, response time] (optional)
        [METRIC_2 - e.g., throughput, success rate]:
          type: number
          format: double
          description: [RESOURCE_INSTANCE - e.g., database connection, workflow instance] [METRIC_2 - e.g., throughput, success rate] (optional)
        [METRIC_3]:
          type: number
          format: double
          description: [RESOURCE_INSTANCE - e.g., database connection, workflow instance] [METRIC_3] (optional)
        [METRIC_4]:
          type: number
          format: double
          description: [RESOURCE_INSTANCE - e.g., database connection, workflow instance] [METRIC_4] (optional)

    PortfolioContext:
      type: object
      required:
        - current_positions
        - portfolio_delta
        - portfolio_heat
        - correlation_score
      properties:
        current_positions:
          type: integer
          minimum: 0
          description: Number of currently open positions
        portfolio_delta:
          type: number
          format: double
          description: Current [RESOURCE_COLLECTION - e.g., user accounts, active sessions] [METRIC_1 - e.g., error rate, response time]
        portfolio_heat:
          type: number
          format: double
          minimum: 0
          description: Current [RESOURCE_COLLECTION - e.g., user accounts, active sessions] heat (total risk capital deployed)
        correlation_score:
          type: number
          format: double
          minimum: -1.0
          maximum: 1.0
          description: [RESOURCE_COLLECTION - e.g., user accounts, active sessions] correlation score

    MarketContext:
      type: object
      required:
        - [VOLATILITY_INDICATOR - e.g., system load, error frequency]
        - market_regime
      properties:
        [VOLATILITY_INDICATOR - e.g., system load, error frequency]:
          type: number
          format: double
          minimum: 0
          description: Current [VOLATILITY_INDICATOR - e.g., system load, error frequency] level
        market_regime:
          type: string
          enum: [stable_bull, volatile_bull, range_bound, stable_bear, volatile_bear]
          description: ML-classified [SYSTEM_STATE - e.g., operating mode, environment condition]

    ValidationPass:
      type: object
      required:
        - request_id
        - timestamp
        - validation_result
        - risk_score
        - checks_performed
      properties:
        request_id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        validation_result:
          type: string
          enum: [PASS]
        risk_score:
          type: number
          format: double
          minimum: 0
          maximum: 1.0
          description: Overall risk score (0=low risk, 1=high risk)
        checks_performed:
          type: array
          items:
            $ref: '#/components/schemas/CheckResult'
        warnings:
          type: array
          items:
            type: string
          description: Non-blocking warnings

    ValidationFail:
      type: object
      required:
        - request_id
        - timestamp
        - validation_result
        - risk_score
        - violations
      properties:
        request_id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        validation_result:
          type: string
          enum: [FAIL]
        risk_score:
          type: number
          format: double
          minimum: 0
          maximum: 1.0
        violations:
          type: array
          items:
            $ref: '#/components/schemas/Violation'
        checks_performed:
          type: array
          items:
            $ref: '#/components/schemas/CheckResult'

    CheckResult:
      type: object
      required:
        - check_name
        - status
      properties:
        check_name:
          type: string
          description: Name of the validation check
          example: "max_positions"
        status:
          type: string
          enum: [PASS, FAIL]
        limit:
          type: number
          format: double
          description: Configured limit for this check
        current_value:
          type: number
          format: double
          description: Current value before new [RESOURCE_INSTANCE - e.g., database connection, workflow instance]
        new_value:
          type: number
          format: double
          description: Projected value after new [RESOURCE_INSTANCE - e.g., database connection, workflow instance]

    Violation:
      type: object
      required:
        - rule
        - severity
        - message
      properties:
        rule:
          type: string
          description: Name of the violated rule
          example: "circuit_breaker_vix"
        severity:
          type: string
          enum: [CRITICAL, HIGH, MEDIUM, LOW]
        limit:
          type: number
          format: double
        current_value:
          type: number
          format: double
        message:
          type: string
          description: Human-readable violation description

    ErrorResponse:
      type: object
      required:
        - error_code
        - message
        - request_id
        - timestamp
      properties:
        error_code:
          type: string
          enum: [INVALID_REQUEST, SERVICE_UNAVAILABLE, INTERNAL_ERROR]
        message:
          type: string
        request_id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        retry_after_seconds:
          type: integer
          description: Seconds to wait before retrying (for 503 only)

  securitySchemes:
    mTLS:
      type: mutualTLS
      description: Mutual TLS authentication required for all requests
