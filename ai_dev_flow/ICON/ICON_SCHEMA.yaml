# =============================================================================
# ðŸ“‹ Document Role: This is a DERIVATIVE of ICON-TEMPLATE.md
# - Authority: ICON-TEMPLATE.md is the single source of truth for ICON structure
# - Purpose: Machine-readable validation rules derived from the template
# - On conflict: Defer to ICON-TEMPLATE.md
# =============================================================================
#
# ICON Schema Definition v1.0
# Purpose: Define valid metadata structure and validation rules for ICON documents
# Usage: Reference by validate_icon.py for automated validation

schema_version: "1.0"
artifact_type: ICON
layer: 11
last_updated: "2025-11-30"

references:
  template: "ICON-TEMPLATE.md"
  creation_rules: "ICON_CREATION_RULES.md"
  validation_rules: "ICON_VALIDATION_RULES.md"

# =============================================================================
# YAML Frontmatter Requirements
# =============================================================================

metadata:
  # Required fields in custom_fields
  required_custom_fields:
    document_type:
      type: string
      required: true
      allowed_values: ["implementation_contract", "template"]
      description: "Must be 'implementation_contract' for documents, 'template' for templates"

    artifact_type:
      type: string
      required: true
      allowed_values: ["ICON"]
      description: "Must be uppercase 'ICON'"

    layer:
      type: integer
      required: true
      allowed_values: [11]
      description: "ICON is always Layer 11 artifact (shared with TASKS)"

    contract_type:
      type: string
      required: true
      allowed_values: ["protocol", "exception", "state-machine", "data-model", "di-interface"]
      description: "Type of implementation contract"

    provider_tasks:
      type: string
      required: true
      pattern: "^TASKS-\\d{2,}$"
      description: "Source TASKS document that defines this contract"

    consumer_count:
      type: integer
      required: true
      minimum: 0
      description: "Number of TASKS files consuming this contract"

  # Optional custom_fields
  optional_custom_fields:
    architecture_approaches:
      type: array
      allowed_values:
        - ["ai-agent-based"]
        - ["traditional-8layer"]
        - ["ai-agent-based", "traditional-8layer"]
      description: "Must be array format"

    priority:
      type: string
      allowed_values: ["primary", "shared", "fallback"]
      description: "Classification tier based on architecture"

    development_status:
      type: string
      allowed_values: ["active", "draft", "deprecated", "reference"]
      description: "Current development status"

  # Required tags
  required_tags:
    - implementation-contract  # Primary identifier
    - layer-11-artifact       # Layer identifier - REQUIRED

  # Forbidden tag patterns (will fail validation)
  forbidden_tag_patterns:
    - "^contract$"              # Use 'implementation-contract' instead
    - "^icon-\\d{2,}$"          # Don't include document number in tags

# =============================================================================
# Document Structure Requirements
# =============================================================================

structure:
  # Required sections
  required_sections:
    - pattern: "^# ICON-\\d{2,}:"
      name: "Title (H1)"
      description: "Single H1 with format ICON-NN: Title"

    - pattern: "^## 1\\. Pre-Creation Checklist$"
      name: "Pre-Creation Checklist"
      description: "Decision checklist for standalone vs embedded contracts"

    - pattern: "^## 2\\. Integration Workflow$"
      name: "Integration Workflow"
      description: "Step-by-step integration process"

    - pattern: "^## 3\\. Executive Summary$"
      name: "Executive Summary"
      description: "Contract overview and consumer list"

    - pattern: "^## 4\\. Contract Definition$"
      name: "Contract Definition"
      description: "Interface specification with code"

    - pattern: "^## 5\\. Provider Requirements$"
      name: "Provider Requirements"
      description: "Implementation requirements for provider"

    - pattern: "^## 6\\. Consumer Requirements$"
      name: "Consumer Requirements"
      description: "Implementation requirements for consumers"

    - pattern: "^## 7\\. Change Management$"
      name: "Change Management"
      description: "Versioning and deprecation policy"

    - pattern: "^## 8\\. Testing Requirements$"
      name: "Testing Requirements"
      description: "Contract testing strategy"

    - pattern: "^## 9\\. Documentation$"
      name: "Documentation"
      description: "Usage examples and documentation"

    - pattern: "^## 10\\. Traceability$"
      name: "Traceability"
      description: "Upstream sources and downstream artifacts"

  # Optional sections
  optional_sections:
    - pattern: "^## 11\\. Change History$"
      name: "Change History"
      description: "Version history table"

  # Document Control table requirements
  document_control:
    required_fields:
      - ICON ID
      - Contract Name
      - Contract Type
      - Version
      - Date Created
      - Last Updated
      - Provider TASKS
      - Consumer Count
      - Status

    optional_fields:
      - Author
      - Reviewer
      - Approver

    status_values:
      - Draft
      - Review
      - Approved
      - Active
      - Deprecated

  # Section numbering rules
  section_numbering:
    start: 1
    end: 10
    format: "## N. Section Title"
    subsection_format: "### N.N Subsection Title"
    no_duplicate_numbers: true

  # File naming convention
  file_naming:
    pattern: "^ICON-\\d{2,}_[a-z0-9_]+\\.md$"
    description: "Format: ICON-NN_descriptive_name.md"

# =============================================================================
# ICON-Specific Patterns
# =============================================================================

icon_patterns:
  # Contract types
  contract_types:
    protocol:
      format: "typing.Protocol"
      description: "Method signatures with type hints"
      example: |
        class IDataProvider(Protocol):
            def fetch_data(self, query: str) -> DataFrame: ...

    exception:
      format: "class XxxError(BaseError)"
      description: "Typed exceptions with error codes"
      example: |
        class ValidationError(ContractError):
            error_code: str
            retry_allowed: bool

    state-machine:
      format: "enum State"
      description: "Valid state transitions"
      example: |
        class OrderState(Enum):
            PENDING = "pending"
            VALIDATED = "validated"
            EXECUTED = "executed"

    data-model:
      format: "Pydantic BaseModel"
      description: "Validation schemas"
      example: |
        class OrderRequest(BaseModel):
            symbol: str
            quantity: int
            order_type: OrderType

    di-interface:
      format: "ABC interface"
      description: "DI patterns"
      example: |
        class ILogger(ABC):
            @abstractmethod
            def log(self, level: str, message: str) -> None: ...

# =============================================================================
# Creation Criteria (ALL must be met for standalone ICON)
# =============================================================================

creation_criteria:
  consumer_threshold: 5        # 5+ TASKS files consuming
  size_threshold: 500          # >500 lines contract definition
  scope: "platform-level"      # Platform-wide shared interface
  cross_project: true          # Used across multiple projects

  decision_matrix:
    - criterion: "Consumer Count"
      threshold: "5+ TASKS files"
      standalone: "5+"
      embedded: "<5"

    - criterion: "Contract Size"
      threshold: ">500 lines"
      standalone: ">500 lines"
      embedded: "<500 lines"

    - criterion: "Scope"
      threshold: "Platform-level interface"
      standalone: "Platform-wide"
      embedded: "Single component"

    - criterion: "Projects"
      threshold: "Cross-project usage"
      standalone: "Multi-project"
      embedded: "Single project"

  default_behavior: "Embed contracts in TASKS files (section 5) unless ALL criteria are met for standalone ICON"

# =============================================================================
# Validation Rules
# =============================================================================

validation_rules:
  # Metadata validation
  metadata:
    - rule: "document_type must be 'implementation_contract' or 'template'"
      severity: error

    - rule: "contract_type must be one of: protocol, exception, state-machine, data-model, di-interface"
      severity: error

    - rule: "provider_tasks must reference valid TASKS-NN format"
      severity: error

    - rule: "consumer_count must be integer >= 0"
      severity: error

    - rule: "tags must include 'implementation-contract' and 'layer-11-artifact'"
      severity: error

    - rule: "forbidden tag patterns must not appear"
      severity: error

  # Structure validation
  structure:
    - rule: "Single H1 heading only"
      severity: warning

    - rule: "All 10 required sections must be present"
      severity: error

    - rule: "Sections must be numbered 1-10 sequentially"
      severity: error

    - rule: "File name must match ICON-NN_name.md format"
      severity: warning

  # Content validation
  content:
    - rule: "Contract Definition must include typed interface code"
      severity: error

    - rule: "Provider Requirements must list implementation constraints"
      severity: warning

    - rule: "Consumer Requirements must list integration requirements"
      severity: warning

    - rule: "Testing Requirements must define contract testing strategy"
      severity: warning

    - rule: "Consumer count should match creation criteria threshold"
      severity: info

# =============================================================================
# Cross-Reference Requirements (Cumulative Tagging - Layer 11)
# =============================================================================

traceability:
  # Cumulative tagging requirements for Layer 11
  cumulative_tags:
    layer: 11
    required:
      - "@brd: BRD.NN.EE.SS"
      - "@prd: PRD.NN.EE.SS"
      - "@ears: EARS.NN.EE.SS"
      - "@bdd: BDD.NN.EE.SS"
      - "@adr: ADR-NN"
      - "@sys: SYS.NN.EE.SS"
      - "@req: REQ.NN.EE.SS"
      - "@spec: SPEC-NN"
    optional:
      - "@impl: IMPL.NN.EE.SS"
      - "@ctr: CTR-NN"
    description: "Layer 11 requires 8 upstream artifact tags (10 including optional IMPL and CTR)"

  upstream:
    required:
      - type: TASKS
        format: "@tasks: TASKS.NN.EE.SS"
        location: "Document Control table (Provider TASKS) or Section 10"
        description: "Source TASKS that defines this contract"

  downstream:
    expected:
      - type: TASKS
        format: "TASKS.NN.EE.SS"
        description: "Consumer TASKS files implementing this contract"
      - type: Code
        format: "src/..."
        description: "Source code implementations"

  # ICON-specific tags
  icon_tags:
    format: "@icon: ICON-NN:ContractName"
    role_tag: "@icon-role: provider|consumer"
    description: "Links to implementation contract definitions"

  same_type:
    optional:
      - type: ICON
        format: "@related-icon: ICON-NN"
        description: "Related ICON document (e.g., exception hierarchy for protocol)"

# =============================================================================
# Error Messages
# =============================================================================

error_messages:
  ICON-E001: "Missing required tag 'implementation-contract'"
  ICON-E002: "Missing required tag 'layer-11-artifact'"
  ICON-E003: "Invalid document_type: must be 'implementation_contract' or 'template'"
  ICON-E004: "Invalid contract_type: must be protocol, exception, state-machine, data-model, or di-interface"
  ICON-E005: "Forbidden tag pattern detected"
  ICON-E006: "Missing required section"
  ICON-E007: "Multiple H1 headings detected"
  ICON-E008: "Section numbering not sequential (1-10)"
  ICON-E009: "Document Control missing required fields"
  ICON-E010: "Missing Contract Definition section (Section 4)"
  ICON-E011: "Missing Traceability section (Section 10)"
  ICON-E012: "Contract Definition has no typed interface code"
  ICON-E013: "File name does not match ICON-NN_name.md format"
  ICON-E014: "Provider TASKS not in valid TASKS-NN format"
  ICON-W001: "Consumer count below standalone threshold (5+)"
  ICON-W002: "Contract size below standalone threshold (500 lines)"
  ICON-W003: "Missing upstream traceability tags (require 8: @brd through @spec)"
  ICON-W004: "Provider Requirements section empty"
  ICON-W005: "Consumer Requirements section empty"
  ICON-W006: "Testing Requirements section empty"
  ICON-I001: "Consider embedding this contract in TASKS if criteria not met"
  ICON-I002: "Consider adding @icon-role tags for clarity"
  ICON-I003: "Consider documenting version compatibility requirements"
