# SPEC-01: External API Client
# Example specification following SPEC-MVP-TEMPLATE.yaml structure
# This demonstrates a complete, compliant SPEC document

id: external_api_client
summary: HTTP client for external API integration with caching, rate limiting, and circuit breaker patterns

# ===================
# METADATA & DOCUMENT CONTROL
# ===================

metadata:
  version: "1.0.0"
  status: "draft"
  created_date: "2026-02-08"
  last_updated: "2026-02-08"
  task_ready_score: "✅ 95% (Target: ≥90%)"
  authors:
    - name: "Integration Team Lead"
      email: "integration@company.com"
      role: "Technical Lead"
  reviewers:
    - name: "Architecture Team"
      email: "architecture@company.com"
      role: "Architecture Review"
  owners:
    - team: "Platform Integration Team"
      contact: "platform@company.com"
      slack: "#platform-integrations"

# ===================
# TRACEABILITY
# ===================

traceability:
  upstream_sources:
    business_requirements:
      - id: "BRD-01"
        link: "../01_BRD/BRD-01_platform_integration.md"
        title: "Platform Integration Strategy"
        relevant_sections: ["2.3", "4.1"]
        relationship: "Business objectives driving external API integration"
        context: "Need for reliable third-party service connectivity"

    product_requirements:
      - id: "PRD-03"
        link: "../02_PRD/PRD-03_api_gateway.md"
        title: "API Gateway Product Requirements"
        relevant_sections: ["3.2 External Integrations"]
        relationship: "Product features for external API management"
        context: "Unified interface for external service calls"

    system_requirements:
      - id: "SYS-02"
        link: "../06_SYS/SYS-02_integration_layer.md"
        title: "Integration Layer Architecture"
        relevant_sections: ["2.1 Service Boundaries"]
        relationship: "System-level integration specifications"
        context: "Resilient external service communication"

    architecture_decisions:
      - id: "ADR-05"
        link: "../05_ADR/ADR-05_circuit_breaker_pattern.md"
        title: "Circuit Breaker Pattern Adoption"
        relevant_sections: ["Decision", "Implementation"]
        relationship: "Architectural approach for resilience"
        context: "Fail-fast pattern for external service failures"

    contracts:
      - id: "CTR-03"
        link: "../08_CTR/CTR-03_external_api_contract.md"
        schema: "../08_CTR/CTR-03_external_api_contract.yaml"
        title: "External API Contract"
        relevant_sections: ["Request Schema", "Response Schema", "Error Codes"]
        relationship: "Interface contract for external API"
        context: "REST API endpoints specification"

    atomic_requirements:
      - id: "REQ-15"
        link: "../07_REQ/SYS-02_integration/REQ-15_api_client.md"
        title: "API Client Requirements"
        relevant_sections: ["Acceptance Criteria"]
        relationship: "Core requirement for API client implementation"
        context: "HTTP client with resilience patterns"

      - id: "REQ-16"
        link: "../07_REQ/SYS-02_integration/REQ-16_rate_limiting.md"
        title: "Rate Limiting Requirements"
        relevant_sections: ["Constraints"]
        relationship: "Rate limiting compliance requirement"
        context: "External API rate limit adherence"

  upstream_links:
    - artifact: "BRD-01"
      path: "../01_BRD/BRD-01_platform_integration.md"
      sections: ["§2.3 Integration Strategy"]
    - artifact: "PRD-03"
      path: "../02_PRD/PRD-03_api_gateway.md"
      sections: ["§3.2 External Integrations"]
    - artifact: "SYS-02"
      path: "../06_SYS/SYS-02_integration_layer.md"
      sections: ["§2.1 Service Boundaries"]
    - artifact: "CTR-03"
      path: "../08_CTR/CTR-03_external_api_contract.md"
      sections: ["§4 Error Handling"]

  downstream_artifacts:
    behavioral_tests:
      - id: "BDD-05"
        link: "../04_BDD/BDD-05_api_client/BDD-05.01_api_operations.feature"
        title: "Feature: API Client Operations"
        scenarios:
          - name: "Successful API call with caching"
            line_ref: "#L12"
            spec_coverage: ["interfaces.external_apis", "caching"]
          - name: "Circuit breaker opens on failure"
            line_ref: "#L34"
            spec_coverage: ["circuit_breaker"]
        relationship: "BDD scenarios validating this SPEC"
        coverage_percentage: 100

    implementation:
      primary_code:
        - path: "src/integrations/external_api_client.py"
          description: "Core API client implementation"
          spec_sections: ["interfaces", "behavior", "caching"]

      tests:
        unit_tests:
          - path: "tests/unit/integrations/test_external_api_client.py"
            description: "Unit tests for API client"
            coverage_target: ">=85%"
            spec_sections: ["verification.unit_tests"]
        integration_tests:
          - path: "tests/integration/integrations/test_api_workflows.py"
            description: "Integration tests for API workflows"
            coverage_target: ">=75%"
            spec_sections: ["verification.integration_tests"]

    implementation_tasks:
      - id: "TASKS-08"
        link: "../11_TASKS/TASKS-08_api_client_implementation.md"
        title: "API Client Implementation Plan"
        status: "pending"
        spec_sections: ["interfaces", "behavior", "implementation"]
        relationship: "Implementation tasks for this component"

  cumulative_tags:
    # File name notation (dash): BRD-NN, PRD-NN - for document-level references
    # Feature ID notation (dot): BRD.NN.EE.SS - for element-level references within documents
    brd: "BRD.01.01.03"      # Feature ID notation (element within BRD-01)
    prd: "PRD.03.01.02"      # Feature ID notation
    ears: "EARS.02.24.01"    # Feature ID notation
    bdd: "BDD.05.13.01"      # Feature ID notation
    adr: "ADR-05"            # Document-level (no sub-elements)
    sys: "SYS.02.25.01"      # Feature ID notation
    req: "REQ.15.26.01"      # Feature ID notation
    ctr: "CTR-03"            # Document-level reference to CTR-03
    threshold: "PRD-03"      # Document-level reference to threshold registry

  validation_evidence:
    requirements_coverage:
      total_requirements: 2
      mapped_requirements: 2
      coverage_percentage: 100
      target_percentage: 100
      unmapped_requirements: []

same_type_references:
  related_spec: ["SPEC-02"]
  depends_spec: []
  # Tags: @related-spec: SPEC-02 (Caching layer), @depends-spec: SPEC-NN

# ===================
# THRESHOLD REGISTRY REFERENCES
# ===================
# All quantitative values use @threshold references (no hardcoded numbers)

threshold_references:
  registry_document: "PRD-03"
  format_reference: "../THRESHOLD_NAMING_RULES.md"

  keys_used:
    performance:
      - key: "perf.api.p95_latency"
        usage: "performance.latency_targets"
      - key: "perf.api.p99_latency"
        usage: "performance.latency_targets"

    timeout:
      - key: "timeout.request.sync"
        usage: "behavior.request_processing"
      - key: "timeout.connection.default"
        usage: "architecture.dependencies"

    limit:
      - key: "limit.api.requests_per_minute"
        usage: "rate_limiting.global_limits"
      - key: "limit.api.burst"
        usage: "rate_limiting.global_limits"

# ===================
# REQ IMPLEMENTATIONS
# ===================

req_implementations:
  - req_id: "REQ-15"
    req_link: "../07_REQ/SYS-02_integration/REQ-15_api_client.md"
    implementation:
      interfaces:
        - class: "ExternalAPIClient"
          method: "get"
          signature: "async def get(self, endpoint: str, params: dict = None) -> APIResponse"
          purpose: "Execute GET request with caching and retry logic"
        - class: "ExternalAPIClient"
          method: "post"
          signature: "async def post(self, endpoint: str, data: dict) -> APIResponse"
          purpose: "Execute POST request with request validation"

      data_models:
        - name: "APIResponse"
          fields:
            - name: "status_code"
              type: "int"
              constraints: "HTTP status code"
            - name: "data"
              type: "dict"
              constraints: "Response body"
            - name: "headers"
              type: "dict"
              constraints: "Response headers"

      validation_rules:
        - rule: "Endpoint URL Validation"
          implementation: |
            if not endpoint.startswith('/'):
                raise ValidationError("Endpoint must start with /")

      error_handling:
        - error_code: "API_TIMEOUT"
          condition: "Request exceeds timeout threshold"
          http_status: 504
          response_message: "Gateway timeout"

      test_approach:
        unit_tests:
          - "Test successful GET request"
          - "Test POST with JSON payload"
          - "Test timeout handling"
        integration_tests:
          - "Test external API integration flow"

  - req_id: "REQ-16"
    req_link: "../07_REQ/SYS-02_integration/REQ-16_rate_limiting.md"
    implementation:
      interfaces:
        - class: "RateLimiter"
          method: "check_limit"
          signature: "def check_limit(self, client_id: str) -> bool"
          purpose: "Check if request is within rate limits"

      validation_rules:
        - rule: "Rate Limit Enforcement"
          implementation: |
            current_count = self.redis.incr(f"rate_limit:{client_id}")
            if current_count > self.limit:
                raise RateLimitExceeded()

      test_approach:
        unit_tests:
          - "Test rate limit counter increment"
          - "Test rate limit exceeded error"

# ===================
# COMPONENT ARCHITECTURE
# ===================

architecture:
  overview: |
    External API Client provides resilient HTTP communication with external services.
    Built on aiohttp for async operations, with Redis-backed caching and circuit breaker
    pattern for fault tolerance.
    
    Components: HTTP Client, Cache Manager, Rate Limiter, Circuit Breaker
    Access Pattern: Async HTTP requests with automatic retries
    Integration: Used by all services requiring external API calls

  component_structure:
    - name: "ExternalAPIClient"
      responsibility: "Main client interface, request orchestration"
      dependencies: ["CacheManager", "RateLimiter", "CircuitBreaker"]
    - name: "CacheManager"
      responsibility: "Redis-backed response caching with TTL"
      dependencies: ["Redis Cluster"]
    - name: "RateLimiter"
      responsibility: "Token bucket rate limiting per client"
      dependencies: ["Redis Cluster"]
    - name: "CircuitBreaker"
      responsibility: "Fail-fast pattern for external failures"
      dependencies: []

  element_ids:
    - id: "SPEC.01.16.01"
      type: "interface"
      name: "GET /api/v1/resource"
      description: "Retrieve resource with caching"
    - id: "SPEC.01.16.02"
      type: "interface"
      name: "POST /api/v1/resource"
      description: "Create new resource"
    - id: "SPEC.01.17.01"
      type: "data_model"
      name: "APIResponse"
      description: "Standard API response wrapper"
    - id: "SPEC.01.21.01"
      type: "validation_rule"
      name: "URL Path Validation"
      description: "Validate endpoint path format"

  pattern: "service"
  domain: "integration"
  category: "client"
  dependencies:
    internal:
      - name: "config_service"
        interface: "ConfigProvider"
        version: ">=1.0.0"
        required: true
    external:
      - name: "external_payment_api"
        interface: "REST API"
        protocol: "https"
        required: true
        fallback_strategy: "cached_response"

  scalability:
    horizontal_scaling: true
    stateless: true
    shared_state_strategy: "redis"

  resilience:
    circuit_breaker_enabled: true
    retry_policy:
      max_attempts: 3
      backoff_strategy: "exponential"
      base_delay_ms: 1000
      max_delay_ms: 30000
    graceful_degradation: true

# ===================
# INTERFACE DEFINITIONS
# ===================

interfaces:
  external_apis:
    - endpoint: "GET /api/v1/resources/{id}"
      method: "GET"
      auth: "API Key"
      rate_limit: "100 req/min"
      request_schema:
        type: "object"
        properties:
          id:
            type: "string"
            format: "uuid"
      response_schema:
        type: "object"
        properties:
          id: { type: "string" }
          data: { type: "object" }
          cached: { type: "boolean" }
      latency_target: "@threshold: PRD.03.perf.api.p95_latency"

    - endpoint: "POST /api/v1/resources"
      method: "POST"
      auth: "API Key"
      rate_limit: "50 req/min"
      request_schema:
        type: "object"
        required: ["name", "value"]
        properties:
          name: { type: "string", minLength: 1 }
          value: { type: "number" }
      response_schema:
        type: "object"
        properties:
          id: { type: "string" }
          status: { type: "string", enum: ["created", "pending"] }
      latency_target: "@threshold: PRD.03.perf.api.p95_latency"

  internal_apis:
    - interface: "ExternalAPIClient.get()"
      signature: "async def get(self, endpoint: str, params: dict = None, use_cache: bool = True) -> APIResponse"
      purpose: |
        1. Check circuit breaker state - if OPEN, raise CircuitBreakerOpenError
        2. If use_cache=True, check cache for existing response
        3. Call rate limiter to check quota
        4. Execute HTTP GET request with timeout
        5. Cache successful response (TTL=300s)
        6. Return APIResponse

    - interface: "ExternalAPIClient.post()"
      signature: "async def post(self, endpoint: str, data: dict) -> APIResponse"
      purpose: |
        1. Validate request data schema
        2. Check circuit breaker state
        3. Execute HTTP POST request
        4. Invalidate related cache entries on success
        5. Return APIResponse

  classes:
    - name: "ExternalAPIClient"
      description: "Main client for external API operations"
      constructor:
        params:
          base_url:
            type: string
            required: true
            description: "External API base URL"
          api_key:
            type: string
            required: true
            description: "API authentication key"
          timeout_seconds:
            type: integer
            default: 30
            description: "Request timeout"
      methods:
        - name: "get"
          description: "Execute GET request with caching"
          input:
            endpoint:
              type: string
              required: true
            params:
              type: object
              required: false
            use_cache:
              type: boolean
              default: true
          output:
            response:
              type: APIResponse
          errors:
            CIRCUIT_OPEN: "Circuit breaker is open"
            RATE_LIMITED: "Rate limit exceeded"

        - name: "post"
          description: "Execute POST request"
          input:
            endpoint:
              type: string
              required: true
            data:
              type: object
              required: true
          output:
            response:
              type: APIResponse
          errors:
            VALIDATION_ERROR: "Invalid request data"

# ===================
# BEHAVIORAL SPECIFICATIONS
# ===================

behavior:
  lifecycle:
    startup_sequence:
      - validate_configuration
      - establish_redis_connection
      - initialize_circuit_breaker
      - enable_request_processing
    shutdown_sequence:
      - stop_accepting_requests
      - close_http_connections
      - cleanup_resources

  state_management:
    description: "Circuit breaker state machine"
    states:
      - CLOSED
      - OPEN
      - HALF_OPEN
    transitions:
      - from: "CLOSED"
        to: "OPEN"
        trigger: "failure_threshold_exceeded"
        side_effects: ["log_state_change", "emit_metric"]
      - from: "OPEN"
        to: "HALF_OPEN"
        trigger: "timeout_elapsed"
        side_effects: ["allow_test_request"]
      - from: "HALF_OPEN"
        to: "CLOSED"
        trigger: "test_request_success"
        side_effects: ["reset_failure_count"]
      - from: "HALF_OPEN"
        to: "OPEN"
        trigger: "test_request_failure"
        side_effects: ["increment_failure_count"]
    invariants:
      - "failure_count <= max_failures OR state == OPEN"

  request_processing:
    concurrency_model: "async"
    max_concurrent_requests: 100
    queue_strategy: "fifo"
    timeout_handling:
      request_timeout_seconds: "@threshold: PRD.03.timeout.request.sync"
      connection_timeout_seconds: "@threshold: PRD.03.timeout.connection.default"
    validation_strategy:
      input_validation: "strict"
      schema_validation: true
    retry_strategy:
      enabled: true
      max_retries: 3
      retryable_errors: ["TIMEOUT", "SERVICE_UNAVAILABLE"]
      backoff_strategy: "exponential"
      jitter_enabled: true

# ===================
# CACHING STRATEGY
# ===================

caching:
  enabled: true
  strategy: "distributed"
  policies:
    api_response:
      ttl_seconds: 300
      max_entries: 10000
      eviction_policy: "lru"
    error_response:
      ttl_seconds: 60
      max_entries: 1000
  layers:
    - level: "distributed"
      backend: "redis"
      configuration:
        host: "redis-cluster"
        port: 6379
        connection_pool_size: 20
  cache_keys:
    strategy: "hash_parameter_based"
    include_parameters: ["endpoint", "params"]
    exclude_parameters: ["correlation_id"]
    hashing_algorithm: "sha256"

# ===================
# RATE LIMITING
# ===================

rate_limiting:
  enabled: true
  strategy: "token_bucket"
  global_limits:
    requests_per_minute: "@threshold: PRD.03.limit.api.requests_per_minute"
    burst_limit: "@threshold: PRD.03.limit.api.burst"
  per_client_limits:
    identified_users:
      requests_per_minute: 60
  enforcement:
    rejection_strategy: "http_429"
    retry_after_header: true

# ===================
# CIRCUIT BREAKER
# ===================

circuit_breaker:
  enabled: true
  strategy: "time_based"
  thresholds:
    failure_percentage: 50
    min_request_volume: 10
    evaluation_window_seconds: 60
  states:
    closed:
      name: "CLOSED"
      behavior: "normal_operation"
    open:
      name: "OPEN"
      behavior: "reject_all_requests"
      wait_seconds: 30
    half_open:
      name: "HALF_OPEN"
      behavior: "test_request_flow"
      test_request_percentage: 10

# ===================
# PERFORMANCE SPECIFICATIONS
# ===================

performance:
  latency_targets:
    p50_milliseconds: 50
    p95_milliseconds: "@threshold: PRD.03.perf.api.p95_latency"
    p99_milliseconds: "@threshold: PRD.03.perf.api.p99_latency"
  throughput_targets:
    sustained_requests_per_second: 100
  resource_limits:
    cpu_cores_allocated: 1
    memory_mb_allocated: 512

# ===================
# SECURITY SPECIFICATIONS
# ===================

security:
  authentication:
    required: true
    methods: ["api_key"]
  authorization:
    enabled: true
    model: "api_key_based"
  input_validation:
    strategy: "schema_based_validation"
    sanitization_enabled: true
  data_protection:
    encryption_in_transit: true
    sensitive_fields: ["api_key"]

# ===================
# OBSERVABILITY SPECIFICATIONS
# ===================

observability:
  metrics:
    standard_metrics:
      - name: "api_requests_total"
        type: "counter"
        labels: ["method", "endpoint", "status_code"]
      - name: "api_request_duration_seconds"
        type: "histogram"
        buckets: [0.1, 0.5, 1.0, 2.0, 5.0]
  logging:
    level: "INFO"
    format: "json"
    correlation_tracking_enabled: true
  health_checks:
    enabled: true
    endpoints:
      - path: "/health/live"
        description: "Liveness probe"
      - path: "/health/ready"
        description: "Readiness probe"

# ===================
# VERIFICATION & VALIDATION
# ===================

verification:
  bdd_scenarios:
    - "../04_BDD/BDD-05_api_client/BDD-05.01_api_operations.feature#L12"
    - "../04_BDD/BDD-05_api_client/BDD-05.01_api_operations.feature#L34"
  performance_tests:
    - target_p95_latency_ms: "@threshold: PRD.03.perf.api.p95_latency"
      test_scenario: "mixed_workload_100_rps"
  integration_tests:
    - dependencies_tested: ["redis", "external_api"]
      test_coverage_min_percent: 85

# ===================
# IMPLEMENTATION SPECIFICS
# ===================

implementation:
  language: "python"
  framework: "aiohttp"
  module_path: "src/integrations/external_api_client.py"
  dependencies:
    runtime:
      - name: "aiohttp"
        version: ">=3.8.0"
      - name: "redis"
        version: ">=4.5.0"
    development:
      - name: "pytest-asyncio"
        version: ">=0.21.0"
  environment_variables:
    - name: "EXTERNAL_API_URL"
      required: true
      sensitive: false
    - name: "EXTERNAL_API_KEY"
      required: true
      sensitive: true
