# SECTEST_MVP_SCHEMA.yaml
# JSON Schema for Security Test Specification validation
# Version: 1.0

$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://ai-dev-flow/schemas/sectest-mvp-v1.0.json"
title: "SECTEST MVP Schema"
description: "Validation schema for Security Test Specification documents"
type: object

required:
  - metadata
  - document_control
  - test_scope
  - test_case_index
  - test_case_details
  - sec_coverage_matrix
  - traceability

properties:
  metadata:
    type: object
    required:
      - document_id
      - title
      - artifact_type
      - layer
      - test_type_code
    properties:
      document_id:
        type: string
        pattern: "^SECTEST-\\d{2,}$"
        description: "Document identifier"
      title:
        type: string
        minLength: 10
      artifact_type:
        type: string
        const: "SECTEST"
      layer:
        type: integer
        const: 10
      test_type_code:
        type: integer
        const: 45
      template_profile:
        type: string
        enum: ["mvp", "full"]
      schema_version:
        type: string

  document_control:
    type: object
    required:
      - status
      - version
      - component
      - spec_reference
      - coverage_target
    properties:
      status:
        type: string
        enum: ["Draft", "Review", "Approved", "Implemented"]
      version:
        type: string
        pattern: "^\\d+\\.\\d+\\.\\d+$"
      date_created:
        type: string
        format: date
      last_updated:
        type: string
        format: date
      author:
        type: string
      component:
        type: string
        minLength: 1
      spec_reference:
        type: string
        pattern: "^SPEC-\\d{2,}$"
      coverage_target:
        type: integer
        minimum: 85
        maximum: 100
      tasks_ready_score:
        type: ["integer", "null"]
        minimum: 0
        maximum: 100

  execution_profile:
    type: object
    description: "Required for security tests with safety constraints"
    required:
      - skip_policy
    properties:
      primary_interface:
        type: string
        enum: ["mcp", "http", "cli", "library", "other"]
      debug_interfaces_allowed:
        type: array
        items:
          type: string
          enum: ["mcp", "http", "cli", "library"]
      required_services:
        type: array
        items:
          type: object
          required:
            - name
            - readiness_check
          properties:
            name:
              type: string
            readiness_check:
              type: object
              required:
                - type
                - value
              properties:
                type:
                  type: string
                  enum: ["command", "http"]
                value:
                  type: string
      required_env_vars:
        type: array
        items:
          type: string
        description: "Environment variable names only (no secret values)"
      ordering:
        type: object
        properties:
          constraints:
            type: array
            items:
              type: string
              pattern: "^(PTEST|SECTEST|UTEST|ITEST|STEST|FTEST)-\\d{3}$"
      skip_policy:
        type: object
        required:
          - conditions
          - rationale
        properties:
          conditions:
            type: string
          rationale:
            type: string

  test_scope:
    type: object
    required:
      - component_under_test
      - test_categories
    properties:
      component_under_test:
        type: object
        required:
          - component
          - spec_reference
          - sec_coverage
        properties:
          component:
            type: string
          module_path:
            type: string
          spec_reference:
            type: string
            pattern: "^SPEC-\\d{2,}$"
          sec_coverage:
            type: array
            items:
              type: string
              pattern: "^SEC\\.\\d{2,}\\.\\d{2}$"
            minItems: 1

      test_categories:
        type: array
        items:
          type: object
          required:
            - category
            - count
          properties:
            category:
              type: string
              enum: ["AuthN", "AuthZ", "Input", "Crypto", "Config", "Session"]
            count:
              type: integer
              minimum: 0
            description:
              type: string

      dependencies:
        type: array
        items:
          type: object
          required:
            - name
            - setup_strategy
          properties:
            name:
              type: string
            setup_strategy:
              type: string

  test_case_index:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - id
        - name
        - category
        - sec_coverage
        - priority
      properties:
        id:
          type: string
          pattern: "^TSPEC\\.\\d{2,}\\.45\\.\\d{2,}$"
        name:
          type: string
          minLength: 5
        category:
          type: string
          enum: ["AuthN", "AuthZ", "Input", "Crypto", "Config", "Session"]
        sec_coverage:
          type: string
          pattern: "^SEC\\.\\d{2,}\\.\\d{2}$"
        priority:
          type: string
          enum: ["P1", "P2", "P3"]

  test_case_details:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - id
        - name
        - category
        - traceability
        - threat_scenario
        - security_controls
      properties:
        id:
          type: string
          pattern: "^TSPEC\\.\\d{2,}\\.45\\.\\d{2,}$"
        name:
          type: string
        category:
          type: string
          enum: ["AuthN", "AuthZ", "Input", "Crypto", "Config", "Session"]
        traceability:
          type: object
          required:
            - sec
            - spec
          properties:
            sec:
              type: string
              pattern: "^SEC\\.\\d{2,}\\.\\d{2}$"
            ctr:
              type: string
              pattern: "^CTR-\\d{2,}$"
            sys:
              type: string
              pattern: "^SYS\\.\\d{2,}\\.\\d{2}$"
            spec:
              type: string
              pattern: "^SPEC-\\d{2,}$"
            spec_section:
              type: string
        threat_scenario:
          type: object
          required:
            - threat_actor
            - attack_vector
            - prerequisites
            - impact
          properties:
            threat_actor:
              type: string
            attack_vector:
              type: string
            prerequisites:
              type: string
            impact:
              type: string
        security_controls:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - control
              - expected_behavior
              - validation_method
            properties:
              control:
                type: string
              expected_behavior:
                type: string
              validation_method:
                type: string
        compliance_mapping:
          type: object
          properties:
            owasp:
              type: array
              items:
                type: string
            cwe:
              type: array
              items:
                type: string

  sec_coverage_matrix:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - sec_id
        - test_ids
        - covered
      properties:
        sec_id:
          type: string
          pattern: "^SEC\\.\\d{2,}\\.\\d{2}$"
        sec_title:
          type: string
        test_ids:
          type: array
          items:
            type: string
            pattern: "^TSPEC\\.\\d{2,}\\.45\\.\\d{2,}$"
          minItems: 1
        covered:
          type: boolean

  coverage_summary:
    type: object
    properties:
      total_sec_elements:
        type: integer
        minimum: 0
      covered:
        type: integer
        minimum: 0
      coverage_percent:
        type: number
        minimum: 0
        maximum: 100

  traceability:
    type: object
    required:
      - upstream
    properties:
      upstream:
        type: array
        minItems: 1
        items:
          type: object
          required:
            - tag
            - reference
          properties:
            tag:
              type: string
              enum: ["@sec", "@ctr", "@sys", "@spec", "@brd", "@prd", "@ears", "@bdd", "@adr", "@req"]
            reference:
              type: string
            description:
              type: string
      downstream:
        type: array
        items:
          type: object
          required:
            - tag
            - reference
          properties:
            tag:
              type: string
              enum: ["@tasks", "@code", "@impl"]
            reference:
              type: string
            description:
              type: string

# Custom validation rules (implemented in validator script)
x-validation-rules:
  sec_tag_required:
    description: "At least one @sec tag must be present in upstream traceability"
    check: "upstream contains tag='@sec'"
  spec_tag_required:
    description: "At least one @spec tag must be present in upstream traceability"
    check: "upstream contains tag='@spec'"
  threat_scenario_complete:
    description: "Each test must have complete threat scenario"
    check: "threat_scenario has all required fields"
  security_controls_minimum:
    description: "Each test must have at least 1 security control"
    check: "security_controls.length >= 1"
  safety_constraint_required:
    description: "Security tests must have skip_policy with safety rationale"
    check: "skip_policy.rationale contains safety/isolated/environment"
  coverage_threshold:
    description: "Coverage must meet target threshold"
    check: "coverage_percent >= coverage_target"
