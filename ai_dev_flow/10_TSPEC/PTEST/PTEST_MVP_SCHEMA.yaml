# PTEST_MVP_SCHEMA.yaml
# JSON Schema for Performance Test Specification validation
# Version: 1.0

$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://ai-dev-flow/schemas/ptest-mvp-v1.0.json"
title: "PTEST MVP Schema"
description: "Validation schema for Performance Test Specification documents"
type: object

required:
  - metadata
  - document_control
  - test_scope
  - test_case_index
  - test_case_details
  - sys_coverage_matrix
  - traceability

properties:
  metadata:
    type: object
    required:
      - document_id
      - title
      - artifact_type
      - layer
      - test_type_code
    properties:
      document_id:
        type: string
        pattern: "^PTEST-\\d{2,}$"
        description: "Document identifier"
      title:
        type: string
        minLength: 10
      artifact_type:
        type: string
        const: "PTEST"
      layer:
        type: integer
        const: 10
      test_type_code:
        type: integer
        const: 44
      template_profile:
        type: string
        enum: ["mvp", "full"]
      schema_version:
        type: string

  document_control:
    type: object
    required:
      - status
      - version
      - component
      - spec_reference
      - coverage_target
    properties:
      status:
        type: string
        enum: ["Draft", "Review", "Approved", "Implemented"]
      version:
        type: string
        pattern: "^\\d+\\.\\d+\\.\\d+$"
      date_created:
        type: string
        format: date
      last_updated:
        type: string
        format: date
      author:
        type: string
      component:
        type: string
        minLength: 1
      spec_reference:
        type: string
        pattern: "^SPEC-\\d{2,}$"
      coverage_target:
        type: integer
        minimum: 80
        maximum: 100
      tasks_ready_score:
        type: ["integer", "null"]
        minimum: 0
        maximum: 100

  execution_profile:
    type: object
    description: "Optional execution environment and dependencies"
    properties:
      primary_interface:
        type: string
        enum: ["mcp", "http", "cli", "library", "other"]
      debug_interfaces_allowed:
        type: array
        items:
          type: string
          enum: ["mcp", "http", "cli", "library"]
      required_services:
        type: array
        items:
          type: object
          required:
            - name
            - readiness_check
          properties:
            name:
              type: string
            readiness_check:
              type: object
              required:
                - type
                - value
              properties:
                type:
                  type: string
                  enum: ["command", "http"]
                value:
                  type: string
      required_env_vars:
        type: array
        items:
          type: string
        description: "Environment variable names only (no secret values)"
      ordering:
        type: object
        properties:
          constraints:
            type: array
            items:
              type: string
              pattern: "^(PTEST|SECTEST|UTEST|ITEST|STEST|FTEST)-\\d{3}$"
      skip_policy:
        type: object
        required:
          - conditions
          - rationale
        properties:
          conditions:
            type: string
          rationale:
            type: string
      baseline_artifact_ref:
        type: string
        description: "Identifier for baseline/reference run"
      comparison_policy:
        type: string
        description: "Rules for comparing current vs baseline"

  test_scope:
    type: object
    required:
      - component_under_test
      - test_categories
    properties:
      component_under_test:
        type: object
        required:
          - component
          - spec_reference
          - sys_coverage
        properties:
          component:
            type: string
          module_path:
            type: string
          spec_reference:
            type: string
            pattern: "^SPEC-\\d{2,}$"
          sys_coverage:
            type: array
            items:
              type: string
              pattern: "^SYS\\.\\d{2,}\\.\\d{2}$"
            minItems: 1

      test_categories:
        type: array
        items:
          type: object
          required:
            - category
            - count
          properties:
            category:
              type: string
              enum: ["Load", "Stress", "Endurance", "Spike"]
            count:
              type: integer
              minimum: 0
            description:
              type: string

      dependencies:
        type: array
        items:
          type: object
          required:
            - name
            - mock_strategy
          properties:
            name:
              type: string
            mock_strategy:
              type: string

  test_case_index:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - id
        - name
        - category
        - sys_coverage
        - priority
      properties:
        id:
          type: string
          pattern: "^TSPEC\\.\\d{2,}\\.44\\.\\d{2,}$"
        name:
          type: string
          minLength: 5
        category:
          type: string
          enum: ["Load", "Stress", "Endurance", "Spike"]
        sys_coverage:
          type: string
          pattern: "^SYS\\.\\d{2,}\\.\\d{2}$"
        priority:
          type: string
          enum: ["P1", "P2", "P3"]

  test_case_details:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - id
        - name
        - category
        - traceability
        - load_scenarios
        - performance_thresholds
        - measurement_strategy
      properties:
        id:
          type: string
          pattern: "^TSPEC\\.\\d{2,}\\.44\\.\\d{2,}$"
        name:
          type: string
        category:
          type: string
          enum: ["Load", "Stress", "Endurance", "Spike"]
        traceability:
          type: object
          required:
            - sys
            - spec
          properties:
            sys:
              type: string
              pattern: "^SYS\\.\\d{2,}\\.\\d{2}$"
            spec:
              type: string
              pattern: "^SPEC-\\d{2,}$"
            spec_section:
              type: string
        load_scenarios:
          type: array
          minItems: 3
          items:
            type: object
            required:
              - load_level
              - concurrent_users
              - duration
            properties:
              load_level:
                type: string
                enum: ["Normal", "Peak", "Stress"]
              concurrent_users:
                type: integer
                minimum: 1
              duration:
                type: string
              target_throughput:
                type: integer
                minimum: 0
        performance_thresholds:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - metric
              - target
              - unit
            properties:
              metric:
                type: string
              target:
                type: number
              maximum:
                type: number
              unit:
                type: string
        measurement_strategy:
          type: object
          required:
            - tool
            - metrics
          properties:
            tool:
              type: string
            metrics:
              type: array
              items:
                type: string
            sampling_method:
              type: string
            baseline_reference:
              type: string

  sys_coverage_matrix:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - sys_id
        - test_ids
        - covered
      properties:
        sys_id:
          type: string
          pattern: "^SYS\\.\\d{2,}\\.\\d{2}$"
        sys_title:
          type: string
        test_ids:
          type: array
          items:
            type: string
            pattern: "^TSPEC\\.\\d{2,}\\.44\\.\\d{2,}$"
          minItems: 1
        covered:
          type: boolean

  coverage_summary:
    type: object
    properties:
      total_sys_elements:
        type: integer
        minimum: 0
      covered:
        type: integer
        minimum: 0
      coverage_percent:
        type: number
        minimum: 0
        maximum: 100

  traceability:
    type: object
    required:
      - upstream
    properties:
      upstream:
        type: array
        minItems: 1
        items:
          type: object
          required:
            - tag
            - reference
          properties:
            tag:
              type: string
              enum: ["@sys", "@spec", "@brd", "@prd", "@ears", "@bdd", "@adr", "@req", "@ctr"]
            reference:
              type: string
            description:
              type: string
      downstream:
        type: array
        items:
          type: object
          required:
            - tag
            - reference
          properties:
            tag:
              type: string
              enum: ["@tasks", "@code", "@impl"]
            reference:
              type: string
            description:
              type: string

# Custom validation rules (implemented in validator script)
x-validation-rules:
  sys_tag_required:
    description: "At least one @sys tag must be present in upstream traceability"
    check: "upstream contains tag='@sys'"
  spec_tag_required:
    description: "At least one @spec tag must be present in upstream traceability"
    check: "upstream contains tag='@spec'"
  load_scenarios_minimum:
    description: "Each test must have at least 3 load scenarios"
    check: "load_scenarios.length >= 3"
  threshold_units:
    description: "Performance thresholds must include units"
    check: "all thresholds have unit field"
  coverage_threshold:
    description: "Coverage must meet target threshold"
    check: "coverage_percent >= coverage_target"
