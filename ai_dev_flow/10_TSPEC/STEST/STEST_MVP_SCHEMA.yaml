# STEST_MVP_SCHEMA.yaml
# JSON Schema for Smoke Test Specification validation
# Version: 1.0

$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://ai-dev-flow/schemas/stest-mvp-v1.0.json"
title: "STEST MVP Schema"
description: "Validation schema for Smoke Test Specification documents"
type: object

required:
  - metadata
  - document_control
  - test_scope
  - critical_path_index
  - test_case_details
  - rollback_procedures
  - traceability

properties:
  metadata:
    type: object
    required:
      - document_id
      - title
      - artifact_type
      - layer
      - test_type_code
    properties:
      document_id:
        type: string
        pattern: "^STEST-\\d{2,}$"
      artifact_type:
        type: string
        const: "STEST"
      layer:
        type: integer
        const: 10
      test_type_code:
        type: integer
        const: 42

  document_control:
    type: object
    required:
      - status
      - deployment_target
      - total_timeout_budget
    properties:
      status:
        type: string
        enum: ["Draft", "Review", "Approved", "Implemented"]
      deployment_target:
        type: string
        minLength: 1
      total_timeout_budget:
        type: integer
        maximum: 300
        description: "Maximum 300 seconds (5 minutes)"
      ears_reference:
        type: string
        pattern: "^EARS\\.\\d{2,}\\.\\d{2}\\.\\d{2,}$"
      bdd_reference:
        type: string
        pattern: "^BDD\\.\\d{2,}\\.\\d{2}\\.\\d{2,}$"

  test_scope:
    type: object
    required:
      - deployment_context
      - timeout_budget
      - critical_paths
    properties:
      deployment_context:
        type: object
        required:
          - environment
          - success_criteria
        properties:
          environment:
            type: string
            enum: ["Production", "Staging", "Dev"]
          deployment_type:
            type: string
            enum: ["Blue-Green", "Rolling", "Canary"]
          trigger:
            type: string
          success_criteria:
            type: string

      timeout_budget:
        type: array
        items:
          type: object
          required:
            - test_id
            - timeout
            - cumulative
          properties:
            test_id:
              type: string
            timeout:
              type: integer
              maximum: 60
            cumulative:
              type: integer
              maximum: 300

      critical_paths:
        type: array
        minItems: 1
        items:
          type: object
          required:
            - path
            - priority
            - impact
          properties:
            path:
              type: string
            priority:
              type: string
              enum: ["P0", "P1"]
            impact:
              type: string

  critical_path_index:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - id
        - path
        - timeout
        - rollback_trigger
        - priority
      properties:
        id:
          type: string
          pattern: "^TSPEC\\.\\d{2,}\\.42\\.\\d{2,}$"
        path:
          type: string
        timeout:
          type: integer
          maximum: 60
        rollback_trigger:
          type: boolean
        priority:
          type: string
          enum: ["P0", "P1"]

  test_case_details:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - id
        - name
        - critical_path
        - traceability
        - timeout
        - pass_fail_criteria
        - health_check
        - rollback_procedure
      properties:
        id:
          type: string
          pattern: "^TSPEC\\.\\d{2,}\\.42\\.\\d{2,}$"
        name:
          type: string
        critical_path:
          type: string
        traceability:
          type: object
          required:
            - ears
            - bdd
            - req
          properties:
            ears:
              type: string
              pattern: "^EARS\\.\\d{2,}\\.\\d{2}\\.\\d{2,}$"
            bdd:
              type: string
              pattern: "^BDD\\.\\d{2,}\\.\\d{2}\\.\\d{2,}$"
            req:
              type: string
              pattern: "^REQ\\.\\d{2,}\\.\\d{2}\\.\\d{2,}$"
        timeout:
          type: integer
          maximum: 60
        pass_fail_criteria:
          type: array
          minItems: 2
          items:
            type: object
            required:
              - condition
              - result
            properties:
              condition:
                type: string
              result:
                type: string
                enum: ["PASS", "FAIL"]
        health_check:
          type: string
          minLength: 10
        rollback_procedure:
          type: array
          minItems: 2
          items:
            type: object
            required:
              - step
              - action
              - command

  rollback_procedures:
    type: object
    required:
      - global_rollback_matrix
      - rollback_commands
    properties:
      global_rollback_matrix:
        type: array
        minItems: 1
      rollback_commands:
        type: object

  traceability:
    type: object
    required:
      - upstream
    properties:
      upstream:
        type: array
        minItems: 3
        items:
          type: object
          required:
            - tag
            - reference
          properties:
            tag:
              type: string
              enum: ["@ears", "@bdd", "@req"]
            reference:
              type: string
