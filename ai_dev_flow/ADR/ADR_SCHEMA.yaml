# =============================================================================
# ðŸ“‹ Document Role: This is a DERIVATIVE of ADR-TEMPLATE.md
# - Authority: ADR-TEMPLATE.md is the single source of truth for ADR structure
# - Purpose: Machine-readable validation rules derived from the template
# - On conflict: Defer to ADR-TEMPLATE.md
# =============================================================================
#
# ADR Schema Definition v1.0
# Purpose: Define valid metadata structure and validation rules for ADR documents
# Usage: Reference by validate_adr.py for automated validation

schema_version: "1.0"
artifact_type: ADR
layer: 5
last_updated: "2025-11-30"

references:
  template: "ADR-TEMPLATE.md"
  creation_rules: "ADR_CREATION_RULES.md"
  validation_rules: "ADR_VALIDATION_RULES.md"

# =============================================================================
# YAML Frontmatter Requirements
# =============================================================================

metadata:
  # Required fields in custom_fields
  required_custom_fields:
    document_type:
      type: string
      required: true
      allowed_values: ["adr", "template"]
      description: "Must be 'adr' for documents, 'template' for templates"

    artifact_type:
      type: string
      required: true
      allowed_values: ["ADR"]
      description: "Must be uppercase 'ADR'"

    layer:
      type: integer
      required: true
      allowed_values: [5]
      description: "ADR is always Layer 5 artifact"

    architecture_approaches:
      type: array
      required: true
      allowed_values:
        - ["ai-agent-based"]
        - ["traditional-8layer"]
        - ["ai-agent-based", "traditional-8layer"]
      description: "Must be array format, not 'architecture_approach' string"

    priority:
      type: string
      required: true
      allowed_values: ["primary", "shared", "fallback"]
      description: "Classification tier based on architecture"

    development_status:
      type: string
      required: true
      allowed_values: ["active", "draft", "deprecated", "reference"]
      description: "Current development status"

  # Optional custom_fields
  optional_custom_fields:
    agent_id:
      type: string
      pattern: "^AGENT-\\d{3}$"
      description: "Required for ai-agent-primary documents"

    template_for:
      type: string
      description: "Required when document_type is 'template'"

  # Required tags
  required_tags:
    - adr                 # Primary identifier (or adr-template for templates)
    - layer-5-artifact    # Layer identifier - REQUIRED

  # Forbidden tag patterns (will fail validation)
  forbidden_tag_patterns:
    - "^architecture-decision$"   # Use 'adr' instead
    - "^decision-record$"         # Use 'adr' instead
    - "^adr-\\d{3}$"              # Don't include document number in tags

# =============================================================================
# Document Structure Requirements
# =============================================================================

structure:
  # Document organized in 4 parts with 14+ sections
  parts:
    - name: "PART 1: Decision Context and Requirements"
      sections: [1, 2, 3, 4, 5, 6]
    - name: "PART 2: Impact Analysis and Architecture"
      sections: [7, 8, 9, 10]
    - name: "PART 3: Implementation Strategy"
      sections: [11, 12, 13]
    - name: "PART 4: Traceability and Documentation"
      sections: [14, 15]

  # Required sections
  required_sections:
    - pattern: "^# ADR-\\d{3}:"
      name: "Title (H1)"
      description: "Single H1 with format ADR-NNN: Title"

    - pattern: "^## 1\\. Document Control$"
      name: "Document Control"
      description: "Section 1 with metadata table"

    - pattern: "^## 2\\. Position in Development Workflow$"
      name: "Position in Development Workflow"
      description: "Section 2 with workflow context"

    - pattern: "^## 3\\. Status$"
      name: "Status"
      description: "Section 3 with decision status"

    - pattern: "^## 4\\. Context$"
      name: "Context"
      description: "Section 4 with Problem Statement, Background, Driving Forces, Constraints"

    - pattern: "^## 5\\. Decision$"
      name: "Decision"
      description: "Section 5 with Chosen Solution, Key Components, Implementation Approach"

    - pattern: "^## 6\\. Requirements Satisfied$"
      name: "Requirements Satisfied"
      description: "Section 6 with Primary Requirements, Source Business Logic, NFRs"

    - pattern: "^## 7\\. Consequences$"
      name: "Consequences"
      description: "Section 7 with Positive and Negative Outcomes"

    - pattern: "^## 8\\. Architecture Flow$"
      name: "Architecture Flow"
      description: "Section 8 with Mermaid diagram"

    - pattern: "^## 9\\. Implementation Assessment$"
      name: "Implementation Assessment"
      description: "Section 9 with Complexity, Dependencies, Resources, Failure Modes"

    - pattern: "^## 10\\. Impact Analysis$"
      name: "Impact Analysis"
      description: "Section 10 with Affected Components, Migration, Testing"

  # Optional sections
  optional_sections:
    - pattern: "^## 11\\. Alternatives Considered$"
      name: "Alternatives Considered"
      description: "Section 11 with rejected alternatives"

    - pattern: "^## 12\\. Security Considerations$"
      name: "Security Considerations"
      description: "Section 12 with security impact"

    - pattern: "^## 13\\. Operational Considerations$"
      name: "Operational Considerations"
      description: "Section 13 with deployment, monitoring"

    - pattern: "^## 14\\. Traceability$"
      name: "Traceability"
      description: "Section 14 with upstream and downstream references"

    - pattern: "^## 15\\. References$"
      name: "References"
      description: "Section 15 with internal and external links"

  # Document Control table requirements
  document_control:
    required_fields:
      - Project Name
      - Document Version
      - Date
      - Document Owner
      - Prepared By
      - Status

    optional_fields:
      - SYS-Ready Score

    status_values:
      - Draft
      - "In Review"
      - Approved
      - Proposed
      - Superseded
      - Deprecated

  # Section numbering rules
  section_numbering:
    start: 1
    format: "## N. Section Title"
    subsection_format: "### N.N Subsection Title"
    no_duplicate_numbers: true

  # File naming convention
  file_naming:
    pattern: "^ADR-\\d{3}_[a-z0-9_]+\\.md$"
    description: "Format: ADR-NNN_descriptive_name.md"

# =============================================================================
# ADR-Specific Patterns
# =============================================================================

adr_patterns:
  # Status values
  status_values:
    - value: "Proposed"
      description: "Decision under consideration"
    - value: "Accepted"
      description: "Decision approved for implementation"
    - value: "Deprecated"
      description: "Decision no longer applicable"
    - value: "Superseded"
      description: "Decision replaced by another ADR"

  # Context subsections (required)
  context_subsections:
    required:
      - "### 4.1 Problem Statement"
      - "### 4.2 Background"
      - "### 4.3 Driving Forces"
      - "### 4.4 Constraints"
    optional:
      - "### 4.5 Technology Stack Compliance"

  # Decision subsections (required)
  decision_subsections:
    required:
      - "### 5.1 Chosen Solution"
      - "### 5.2 Key Components"
      - "### 5.3 Implementation Approach"

  # Consequences subsections (required)
  consequences_subsections:
    required:
      - "### 7.1 Positive Outcomes"
      - "### 7.2 Negative Outcomes"

  # Implementation Assessment subsections
  implementation_assessment:
    required:
      - "### 9.1 Complexity Evaluation"
      - "### 9.2 Dependencies"
    optional:
      - "### 9.3 Resources"
      - "### 9.4 Failure Modes & Recovery"
      - "### 9.5 Rollback Plan"
      - "### 9.6 Compatibility"
      - "### 9.7 Monitoring & Observability"

  # Architecture Flow (Mermaid diagram)
  architecture_flow:
    required: true
    format: "mermaid"
    diagram_types:
      - "flowchart"
      - "sequenceDiagram"
      - "stateDiagram-v2"

  # SYS-Ready Score components
  sys_ready_score:
    min_threshold: 90
    components:
      problem_statement:
        weight: 15
        criteria: "Clear technical problem requiring architectural resolution"
      context_completeness:
        weight: 15
        criteria: "Background, driving forces, constraints documented"
      decision_clarity:
        weight: 20
        criteria: "Solution, components, approach clearly defined"
      consequences_analysis:
        weight: 15
        criteria: "Positive and negative outcomes documented"
      architecture_diagram:
        weight: 10
        criteria: "Mermaid flowchart with interactions"
      implementation_assessment:
        weight: 15
        criteria: "Complexity, dependencies, failure modes"
      traceability:
        weight: 10
        criteria: "Upstream PRD/EARS/BDD references"

# =============================================================================
# Validation Rules
# =============================================================================

validation_rules:
  # Metadata validation
  metadata:
    - rule: "document_type must be 'adr' or 'template'"
      severity: error

    - rule: "architecture_approaches must be array"
      severity: error
      fix: "Change 'architecture_approach: value' to 'architecture_approaches: [value]'"

    - rule: "tags must include 'adr' (or 'adr-template') and 'layer-5-artifact'"
      severity: error

    - rule: "forbidden tag patterns must not appear"
      severity: error

  # Structure validation
  structure:
    - rule: "Single H1 heading only"
      severity: warning

    - rule: "Sections 1-10 are required"
      severity: error

    - rule: "Document Control must have minimum 6 fields"
      severity: error

    - rule: "File name must match ADR-NNN_name.md format"
      severity: warning

  # Content validation
  content:
    - rule: "Context section must include Problem Statement subsection"
      severity: error

    - rule: "Context section must include Constraints subsection"
      severity: warning

    - rule: "Decision section must include Chosen Solution"
      severity: error

    - rule: "Consequences section must include both Positive and Negative Outcomes"
      severity: error

    - rule: "Architecture Flow must contain Mermaid diagram"
      severity: warning

    - rule: "Implementation Assessment must include Complexity Evaluation"
      severity: warning

    - rule: "Requirements Satisfied must reference PRD/EARS/BDD documents"
      severity: warning

# =============================================================================
# Cross-Reference Requirements (Cumulative Tagging - Layer 5)
# =============================================================================

traceability:
  # Cumulative tagging requirements for Layer 5
  cumulative_tags:
    layer: 5
    required:
      - "@brd: BRD.NNN.NNN"
      - "@prd: PRD.NNN.NNN"
      - "@ears: EARS.NNN.NNN"
      - "@bdd: BDD.NNN.NNN"
    description: "Layer 5 requires @brd, @prd, @ears, @bdd tags for complete traceability"

  upstream:
    required:
      - type: BRD
        format: "@brd: BRD-NNN"
        location: "Traceability section or Requirements Satisfied"
      - type: PRD
        format: "@prd: PRD-NNN"
        location: "Traceability section or Requirements Satisfied"
      - type: EARS
        format: "@ears: EARS-NNN"
        location: "Traceability section or Requirements Satisfied"
      - type: BDD
        format: "@bdd: BDD-NNN"
        location: "Traceability section or Requirements Satisfied"

  downstream:
    expected:
      - type: SYS
        format: "SYS-NNN"
      - type: REQ
        format: "REQ-NNN"
      - type: SPEC
        format: "SPEC-NNN"

  same_type:
    optional:
      - type: ADR
        format: "@related-adr: ADR-NNN"
        description: "Related ADR document sharing architectural context"
      - type: ADR
        format: "@supersedes: ADR-NNN"
        description: "ADR that this decision supersedes"
      - type: ADR
        format: "@depends-adr: ADR-NNN"
        description: "Prerequisite ADR document"

# =============================================================================
# Error Messages
# =============================================================================

error_messages:
  E001: "Missing required tag 'adr'"
  E002: "Missing required tag 'layer-5-artifact'"
  E003: "Invalid document_type: must be 'adr' or 'template'"
  E004: "Invalid architecture format: use 'architecture_approaches: [value]' array"
  E005: "Forbidden tag pattern detected"
  E006: "Missing required section"
  E007: "Multiple H1 headings detected"
  E008: "Missing Context section (Section 4)"
  E009: "Missing Decision section (Section 5)"
  E010: "Missing Consequences section (Section 7)"
  E011: "Context missing Problem Statement subsection"
  E012: "Decision missing Chosen Solution subsection"
  E013: "Consequences missing Positive or Negative Outcomes"
  E014: "File name does not match ADR-NNN_name.md format"
  W001: "Missing Architecture Flow Mermaid diagram"
  W002: "Context missing Constraints subsection"
  W003: "Missing upstream traceability tags (@prd, @ears, @bdd)"
  W004: "Implementation Assessment missing Complexity Evaluation"
  W005: "SYS-Ready Score below 90% threshold"
  W006: "Requirements Satisfied table missing"
  I001: "Consider adding Alternatives Considered section"
  I002: "Consider adding Security Considerations section"
  I003: "Consider adding Rollback Plan in Implementation Assessment"
