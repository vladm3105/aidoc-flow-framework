# =============================================================================
# ðŸ“‹ Document Role: This is a DERIVATIVE of SYS-TEMPLATE.md
# - Authority: SYS-TEMPLATE.md is the single source of truth for SYS structure
# - Purpose: Machine-readable validation rules derived from the template
# - On conflict: Defer to SYS-TEMPLATE.md
# =============================================================================
#
# SYS Schema Definition v1.0
# Purpose: Define valid metadata structure and validation rules for SYS documents
# Usage: Reference by validate_sys.py for automated validation

schema_version: "1.0"
artifact_type: SYS
layer: 6
last_updated: "2025-11-30"

references:
  template: "SYS-TEMPLATE.md"
  creation_rules: "SYS_CREATION_RULES.md"
  validation_rules: "SYS_VALIDATION_RULES.md"

# =============================================================================
# YAML Frontmatter Requirements
# =============================================================================

metadata:
  # Required fields in custom_fields
  required_custom_fields:
    document_type:
      type: string
      required: true
      allowed_values: ["sys", "template"]
      description: "Must be 'sys' for documents, 'template' for templates"

    artifact_type:
      type: string
      required: true
      allowed_values: ["SYS"]
      description: "Must be uppercase 'SYS'"

    layer:
      type: integer
      required: true
      allowed_values: [6]
      description: "SYS is always Layer 6 artifact"

    architecture_approaches:
      type: array
      required: true
      allowed_values:
        - ["ai-agent-based"]
        - ["traditional-8layer"]
        - ["ai-agent-based", "traditional-8layer"]
      description: "Must be array format, not 'architecture_approach' string"

    priority:
      type: string
      required: true
      allowed_values: ["primary", "shared", "fallback"]
      description: "Classification tier based on architecture"

    development_status:
      type: string
      required: true
      allowed_values: ["active", "draft", "deprecated", "reference"]
      description: "Current development status"

  # Optional custom_fields
  optional_custom_fields:
    agent_id:
      type: string
      pattern: "^AGENT-\\d{3}$"
      description: "Required for ai-agent-primary documents"

    template_for:
      type: string
      description: "Required when document_type is 'template'"

  # Required tags
  required_tags:
    - sys                 # Primary identifier (or sys-template for templates)
    - layer-6-artifact    # Layer identifier - REQUIRED

  # Forbidden tag patterns (will fail validation)
  forbidden_tag_patterns:
    - "^system-requirements$"     # Use 'sys' instead
    - "^sys-doc$"                 # Use 'sys' instead
    - "^sys-\\d{3}$"              # Don't include document number in tags

# =============================================================================
# Document Structure Requirements
# =============================================================================

structure:
  # Required sections (15 sections)
  required_sections:
    - pattern: "^# SYS-\\d{3}:"
      name: "Title (H1)"
      description: "Single H1 with format SYS-NNN: Title"

    - pattern: "^## 1\\. Document Control$"
      name: "Document Control"
      description: "Section 1 with metadata table"

    - pattern: "^## 2\\. Executive Summary$"
      name: "Executive Summary"
      description: "Section 2 with system overview"

    - pattern: "^## 3\\. Scope$"
      name: "Scope"
      description: "Section 3 with System Boundaries, Inclusions, Exclusions"

    - pattern: "^## 4\\. Functional Requirements$"
      name: "Functional Requirements"
      description: "Section 4 with FR-NNN requirements"

    - pattern: "^## 5\\. Quality Attributes$"
      name: "Quality Attributes"
      description: "Section 5 with quality attribute requirements (Performance, Reliability, etc.)"

    - pattern: "^## 6\\. Interface Specifications$"
      name: "Interface Specifications"
      description: "Section 6 with External Interfaces, Internal Interfaces, Data Formats"

    - pattern: "^## 7\\. Data Management$"
      name: "Data Management"
      description: "Section 7 with Data Model, Storage, Migration"

    - pattern: "^## 8\\. Testing Requirements$"
      name: "Testing Requirements"
      description: "Section 8 with Test Strategy, Coverage, Acceptance Criteria"

    - pattern: "^## 9\\. Deployment Requirements$"
      name: "Deployment Requirements"
      description: "Section 9 with Infrastructure, Configuration, Rollback"

    - pattern: "^## 10\\. Compliance Requirements$"
      name: "Compliance Requirements"
      description: "Section 10 with Regulatory, Security, Audit"

    - pattern: "^## 11\\. Acceptance Criteria$"
      name: "Acceptance Criteria"
      description: "Section 11 with Functional, Performance, Security criteria"

    - pattern: "^## 12\\. Risk Assessment$"
      name: "Risk Assessment"
      description: "Section 12 with Technical Risks, Mitigation, Contingency"

    - pattern: "^## 13\\. Traceability$"
      name: "Traceability"
      description: "Section 13 with Upstream Sources, Downstream Artifacts"

    - pattern: "^## 14\\. Implementation Notes$"
      name: "Implementation Notes"
      description: "Section 14 with Technical Guidance, Dependencies"

    - pattern: "^## 15\\. Change History$"
      name: "Change History"
      description: "Section 15 with version history table"

  # Document Control table requirements
  document_control:
    required_fields:
      - SYS ID
      - Document Name
      - Version
      - Date Created
      - Last Updated
      - Author
      - Reviewer
      - Status

    optional_fields:
      - Approver
      - REQ-Ready Score

    status_values:
      - Draft
      - Review
      - Approved
      - Implemented
      - Deprecated

  # Section numbering rules
  section_numbering:
    start: 1
    end: 15
    format: "## N. Section Title"
    subsection_format: "### N.N Subsection Title"
    no_duplicate_numbers: true

  # File naming convention
  file_naming:
    pattern: "^SYS-\\d{3}_[a-z0-9_]+\\.md$"
    description: "Format: SYS-NNN_descriptive_name.md"

# =============================================================================
# SYS-Specific Patterns
# =============================================================================

sys_patterns:
  # Functional requirement format
  functional_requirements:
    format: "FR-NNN"
    pattern: "^FR-\\d{3}$"
    description: "Functional requirement identifier"
    table_columns:
      - "FR-ID"
      - "Requirement"
      - "Priority"
      - "Source"
      - "Verification Method"
    priority_values:
      - "Must Have"
      - "Should Have"
      - "Could Have"
      - "Won't Have"

  # Quality attribute requirement format (Unified numbering - per ID_NAMING_STANDARDS.md)
  # Uses sequential numbering for all requirements (unified 4-segment format)
  quality_attributes:
    format: "SYS.NN.25.SS"
    pattern: "^SYS\\.[0-9]{2,9}\\.[0-9]{2,9}\\.[0-9]{2,9}$"
    description: "Unified quality attribute identifier using 4-segment format: DOC_NUM.ELEM_TYPE.SEQ"
    cross_reference_format:
      pattern: "@sys: SYS.NN.25.SS"
      example: "@sys: SYS.08.25.15"
    categories:
      performance:
        keywords: ["latency", "response time", "throughput", "p50", "p95", "p99", "milliseconds", "TPS", "RPS"]
        metrics:
          - "Response Time"
          - "Throughput"
          - "Latency (p50/p95/p99)"
          - "Resource Utilization"
      reliability:
        keywords: ["uptime", "availability", "MTBF", "MTTR", "error rate", "failover", "recovery", "redundancy"]
        metrics:
          - "Availability"
          - "MTBF"
          - "MTTR"
          - "Error Rate"
      scalability:
        keywords: ["concurrent", "horizontal", "vertical", "scaling", "load", "capacity", "volume", "elasticity"]
        metrics:
          - "Concurrent Users"
          - "Data Volume"
          - "Transaction Rate"
          - "Horizontal Scaling"
      security:
        keywords: ["auth", "encrypt", "RBAC", "compliance", "audit", "token", "certificate", "vulnerability"]
        metrics:
          - "Authentication"
          - "Authorization"
          - "Encryption"
          - "Audit Logging"
      observability:
        keywords: ["log", "monitor", "alert", "trace", "metric", "dashboard", "APM", "health check"]
        metrics:
          - "Logging"
          - "Monitoring"
          - "Alerting"
          - "Tracing"
      maintainability:
        keywords: ["coverage", "deploy", "CI/CD", "documentation", "refactor", "technical debt"]
        metrics:
          - "Code Coverage"
          - "Documentation"
          - "Deployment Frequency"

  # REQ-Ready Score components
  req_ready_score:
    min_threshold: 90
    components:
      functional_completeness:
        weight: 20
        criteria: "All functional requirements defined with FR-NNN format"
      quality_attribute_completeness:
        weight: 20
        criteria: "All quality attribute categories addressed with measurable targets"
      interface_specification:
        weight: 15
        criteria: "External and internal interfaces documented"
      data_management:
        weight: 10
        criteria: "Data model, storage, migration defined"
      testing_requirements:
        weight: 10
        criteria: "Test strategy with coverage targets"
      acceptance_criteria:
        weight: 15
        criteria: "Clear acceptance criteria for all requirements"
      traceability:
        weight: 10
        criteria: "Complete upstream references (BRD, PRD, EARS, BDD, ADR)"

# =============================================================================
# Validation Rules
# =============================================================================

validation_rules:
  # Metadata validation
  metadata:
    - rule: "document_type must be 'sys' or 'template'"
      severity: error

    - rule: "architecture_approaches must be array"
      severity: error
      fix: "Change 'architecture_approach: value' to 'architecture_approaches: [value]'"

    - rule: "tags must include 'sys' (or 'sys-template') and 'layer-6-artifact'"
      severity: error

    - rule: "forbidden tag patterns must not appear"
      severity: error

  # Structure validation
  structure:
    - rule: "Single H1 heading only"
      severity: warning

    - rule: "All 15 required sections must be present"
      severity: error

    - rule: "Sections must be numbered 1-15 sequentially"
      severity: error

    - rule: "Document Control must have minimum 8 fields"
      severity: error

    - rule: "File name must match SYS-NNN_name.md format"
      severity: warning

  # Content validation
  content:
    - rule: "Functional Requirements must use FR-NNN format"
      severity: warning

    - rule: "Quality Attributes must use 4-segment numbering (e.g., SYS.08.25.15)"
      severity: warning

    - rule: "Quality attributes section must cover Performance, Reliability, Security"
      severity: warning

    - rule: "Interface Specifications must define External Interfaces"
      severity: warning

    - rule: "Testing Requirements must specify Coverage Targets"
      severity: warning

    - rule: "Acceptance Criteria must be measurable"
      severity: warning

# =============================================================================
# Cross-Reference Requirements (Cumulative Tagging - Layer 6)
# =============================================================================

traceability:
  # Cumulative tagging requirements for Layer 6
  cumulative_tags:
    layer: 6
    required:
      - "@brd: BRD.NN.01.SS"
      - "@prd: PRD.NN.07.SS"
      - "@ears: EARS.NN.24.SS"
      - "@bdd: BDD.NN.13.SS"
      - "@adr: ADR-NNN"
    description: "Layer 6 requires @brd, @prd, @ears, @bdd, @adr tags for complete traceability (4-segment format)"

  upstream:
    required:
      - type: BRD
        format: "@brd: BRD.NN.01.SS"
        location: "Section 13 Traceability or Traceability Tags section"
      - type: PRD
        format: "@prd: PRD.NN.07.SS"
        location: "Section 13 Traceability or Traceability Tags section"
      - type: EARS
        format: "@ears: EARS.NN.24.SS"
        location: "Section 13 Traceability or Traceability Tags section"
      - type: BDD
        format: "@bdd: BDD.NN.13.SS"
        location: "Section 13 Traceability or Traceability Tags section"
      - type: ADR
        format: "@adr: ADR-NNN"
        location: "Section 13 Traceability or Traceability Tags section"

  downstream:
    expected:
      - type: REQ
        format: "REQ-NNN"
      - type: SPEC
        format: "SPEC-NNN"
      - type: TASKS
        format: "TASKS-NNN"

  same_type:
    optional:
      - type: SYS
        format: "@related-sys: SYS-NNN"
        description: "Related SYS document sharing system context"
      - type: SYS
        format: "@depends-sys: SYS-NNN"
        description: "Prerequisite SYS document"

# =============================================================================
# Error Messages
# =============================================================================

error_messages:
  SYS-E001: "Missing required tag 'sys'"
  SYS-E002: "Missing required tag 'layer-6-artifact'"
  SYS-E003: "Invalid document_type: must be 'sys' or 'template'"
  SYS-E004: "Invalid architecture format: use 'architecture_approaches: [value]' array"
  SYS-E005: "Forbidden tag pattern detected"
  SYS-E006: "Missing required section"
  SYS-E007: "Multiple H1 headings detected"
  SYS-E008: "Section numbering not sequential (1-15)"
  SYS-E009: "Document Control missing required fields"
  SYS-E010: "Missing Functional Requirements section (Section 4)"
  SYS-E011: "Missing Quality Attributes section (Section 5)"
  SYS-E012: "Missing Traceability section (Section 13)"
  SYS-E013: "File name does not match SYS-NNN_name.md format"
  SYS-W001: "Functional requirements not using FR-NNN format"
  SYS-W002: "Quality attributes not using 4-segment numbering (e.g., SYS.08.25.15)"
  SYS-W003: "Quality attributes section missing Performance category"
  SYS-W004: "Quality attributes section missing Security category"
  SYS-W005: "Missing upstream traceability tags (require 5: @brd, @prd, @ears, @bdd, @adr)"
  SYS-W006: "REQ-Ready Score below 90% threshold"
  SYS-W007: "Testing Requirements missing coverage targets"
  SYS-I001: "Consider adding latency percentiles (p50/p95/p99) in Performance requirements"
  SYS-I002: "Consider adding MTBF/MTTR metrics in Reliability requirements"
