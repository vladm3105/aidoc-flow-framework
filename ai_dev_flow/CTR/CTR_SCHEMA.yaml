# =============================================================================
# ðŸ“‹ Document Role: This is a DERIVATIVE of CTR-TEMPLATE.md
# - Authority: CTR-TEMPLATE.md is the single source of truth for CTR structure
# - Purpose: Machine-readable validation rules derived from the template
# - On conflict: Defer to CTR-TEMPLATE.md
# =============================================================================
#
# CTR Schema Definition v1.0
# Purpose: Define valid metadata structure and validation rules for CTR contract documents
# Usage: Reference by validate_ctr.py for automated validation

schema_version: "1.0"
artifact_type: CTR
layer: 9
last_updated: "2025-11-30"

references:
  template: "CTR-TEMPLATE.md"
  creation_rules: "CTR_CREATION_RULES.md"
  validation_rules: "CTR_VALIDATION_RULES.md"

# =============================================================================
# YAML Frontmatter Requirements
# =============================================================================

metadata:
  # Required fields in custom_fields
  required_custom_fields:
    document_type:
      type: string
      required: true
      allowed_values: ["ctr", "template"]
      description: "Must be 'ctr' for documents, 'template' for templates"

    artifact_type:
      type: string
      required: true
      allowed_values: ["CTR"]
      description: "Must be uppercase 'CTR'"

    layer:
      type: integer
      required: true
      allowed_values: [9]
      description: "CTR is always Layer 9 artifact"

    architecture_approaches:
      type: array
      required: true
      allowed_values:
        - ["ai-agent-based"]
        - ["traditional-8layer"]
        - ["ai-agent-based", "traditional-8layer"]
      description: "Must be array format, not 'architecture_approach' string"

    priority:
      type: string
      required: true
      allowed_values: ["primary", "shared", "fallback"]
      description: "Classification tier based on architecture"

    development_status:
      type: string
      required: true
      allowed_values: ["active", "draft", "deprecated", "reference"]
      description: "Current development status"

  # Optional custom_fields
  optional_custom_fields:
    agent_id:
      type: string
      pattern: "^AGENT-\\d{3}$"
      description: "Required for ai-agent-primary documents"

    template_for:
      type: string
      description: "Required when document_type is 'template'"

  # Required tags
  required_tags:
    - ctr                 # Primary identifier (or ctr-template for templates)
    - layer-9-artifact    # Layer identifier - REQUIRED

  # Forbidden tag patterns (will fail validation)
  forbidden_tag_patterns:
    - "^ctr-document$"          # Use 'ctr' instead
    - "^contract$"              # Use 'ctr' instead
    - "^api-contract$"          # Use 'ctr' instead
    - "^ctr-\\d{3}$"            # Don't include document number in tags

# =============================================================================
# Document Structure Requirements (Dual-File Format)
# =============================================================================

structure:
  # CTR uses dual-file format: .md (documentation) + .yaml (schema)
  file_format:
    documentation: ".md"
    schema: ".yaml"
    naming_pattern:
      md: "^CTR-\\d{3}_[a-z0-9_]+\\.md$"
      yaml: "^CTR-\\d{3}_[a-z0-9_]+\\.yaml$"
    description: "CTR-NNN_descriptive_name.md + CTR-NNN_descriptive_name.yaml"

  # Required sections in .md file (organized in 5 parts)
  required_sections:
    # Part 1: Contract Context and Requirements
    - pattern: "^# CTR-\\d{3}:"
      name: "Title (H1)"
      description: "Single H1 with format CTR-NNN: Title"

    - pattern: "^## 1\\. Document Control$"
      name: "Document Control"
      description: "Section 1 with metadata table"

    - pattern: "^## 2\\. Status$"
      name: "Status"
      description: "Section 2 with contract status and versioning"

    - pattern: "^## 3\\. Context$"
      name: "Context"
      description: "Section 3 with Problem Statement, Background, Driving Forces, Constraints"

    - pattern: "^## 4\\. Contract Definition$"
      name: "Contract Definition"
      description: "Section 4 with Interface Overview, Parties, Communication Pattern"

    - pattern: "^## 5\\. Requirements Satisfied$"
      name: "Requirements Satisfied"
      description: "Section 5 with Primary Requirements, Source Business Logic, NFRs"

    # Part 2: Interface Specification and Schema
    - pattern: "^## 6\\. Schema Reference$"
      name: "Schema Reference"
      description: "Section 6 with YAML schema file link and overview"

    - pattern: "^## 7\\. Interface Definition$"
      name: "Interface Definition"
      description: "Section 7 with Endpoints/Functions/Messages"

    - pattern: "^## 8\\. Error Handling$"
      name: "Error Handling"
      description: "Section 8 with Error Codes and Failure Modes"

    - pattern: "^## 9\\. Consequences$"
      name: "Consequences"
      description: "Section 9 with Positive and Negative Outcomes"

    # Part 3: Non-Functional Requirements and Operations
    - pattern: "^## 10\\. Non-Functional Requirements$"
      name: "Non-Functional Requirements"
      description: "Section 10 with Performance, Reliability, Security"

    - pattern: "^## 11\\. Versioning Strategy$"
      name: "Versioning Strategy"
      description: "Section 11 with Version Policy, Compatibility, Deprecation"

    - pattern: "^## 12\\. Examples$"
      name: "Examples"
      description: "Section 12 with Request/Response examples"

    - pattern: "^## 13\\. Monitoring & Observability$"
      name: "Monitoring & Observability"
      description: "Section 13 with Success Metrics, Error Tracking"

    - pattern: "^## 14\\. Alternatives Considered$"
      name: "Alternatives Considered"
      description: "Section 14 with rejected alternative approaches"

    # Part 4: Testing and Implementation
    - pattern: "^## 15\\. Verification$"
      name: "Verification"
      description: "Section 15 with Contract Testing, BDD Scenarios"

    - pattern: "^## 16\\. Impact Analysis$"
      name: "Impact Analysis"
      description: "Section 16 with Affected Components, Migration, Security"

    - pattern: "^## 17\\. Related Contracts$"
      name: "Related Contracts"
      description: "Section 17 with contract dependencies and relations"

    - pattern: "^## 18\\. Implementation Notes$"
      name: "Implementation Notes"
      description: "Section 18 with Development Phases, Code Locations"

    # Part 5: Traceability and Documentation
    - pattern: "^## 19\\. Traceability$"
      name: "Traceability"
      description: "Section 19 with Upstream Sources, Downstream Artifacts"

    - pattern: "^## 20\\. References$"
      name: "References"
      description: "Section 20 with Internal and External Links"

  # Document Control table requirements
  document_control:
    required_fields:
      - Project Name
      - Document Version
      - Date
      - Document Owner
      - Prepared By
      - Status

    optional_fields:
      - Approver

    status_values:
      - Draft
      - "In Review"
      - Approved
      - Active
      - Deprecated

  # Section numbering rules
  section_numbering:
    start: 1
    end: 20
    format: "## N. Section Title"
    subsection_format: "### N.N Subsection Title"
    no_duplicate_numbers: true

# =============================================================================
# YAML Schema File Requirements
# =============================================================================

yaml_schema:
  # Required sections in companion .yaml file
  required_sections:
    - openapi_version: "3.0.x or 3.1.x"
      description: "OpenAPI specification version"
    - info:
        - title
        - version
        - description
    - paths:
        description: "API endpoint definitions"
    - components:
        - schemas:
            description: "Request/Response schemas"

  # Alternative: JSON Schema format
  alternative_formats:
    - name: "JSON Schema"
      required_fields:
        - "$schema"
        - title
        - type
        - properties
    - name: "AsyncAPI"
      required_fields:
        - asyncapi
        - info
        - channels

  # Schema validation rules
  schema_requirements:
    - rule: "All request schemas must define required fields"
      severity: error
    - rule: "All response schemas must define required fields"
      severity: error
    - rule: "Error responses must follow ErrorResponse schema"
      severity: warning

# =============================================================================
# CTR-Specific Patterns
# =============================================================================

ctr_patterns:
  # Contract status values
  status_values:
    - value: "Draft"
      description: "Initial development, not ready for use"
    - value: "Active"
      description: "In production use"
    - value: "Deprecated"
      description: "Scheduled for removal"

  # Communication patterns
  communication_patterns:
    - type: "Synchronous"
      protocols: ["REST", "gRPC", "GraphQL"]
      description: "Request/Response pattern"
    - type: "Asynchronous"
      protocols: ["Event-driven", "Message Queue", "Pub/Sub"]
      description: "Event/Message pattern"

  # Error code format
  error_codes:
    format: "^[A-Z_]+$"
    examples:
      - "INVALID_INPUT"
      - "INSUFFICIENT_DATA"
      - "RATE_LIMITED"
      - "SERVICE_UNAVAILABLE"
      - "INTERNAL_ERROR"
    http_mapping:
      "INVALID_INPUT": 400
      "INSUFFICIENT_DATA": 400
      "RATE_LIMITED": 429
      "SERVICE_UNAVAILABLE": 503
      "INTERNAL_ERROR": 500

  # Versioning pattern
  versioning:
    format: "MAJOR.MINOR.PATCH"
    description: "Semantic versioning required"
    rules:
      major: "Breaking changes (incompatible schema)"
      minor: "Backward-compatible additions"
      patch: "Backward-compatible fixes"

# =============================================================================
# Contract Testing Requirements
# =============================================================================

testing_patterns:
  provider_tests:
    required: true
    categories:
      - "Schema validation"
      - "Error handling"
      - "Performance"
      - "Idempotency"

  consumer_tests:
    required: true
    categories:
      - "Request generation"
      - "Response handling"
      - "Error handling"
      - "Retry logic"

  contract_tests:
    required: true
    frameworks:
      - "Pact"
      - "Spring Cloud Contract"
    description: "Consumer-driven contract testing"

# =============================================================================
# Validation Rules
# =============================================================================

validation_rules:
  # Metadata validation
  metadata:
    - rule: "document_type must be 'ctr' or 'template'"
      severity: error

    - rule: "architecture_approaches must be array"
      severity: error
      fix: "Change 'architecture_approach: value' to 'architecture_approaches: [value]'"

    - rule: "tags must include 'ctr' (or 'ctr-template') and 'layer-9-artifact'"
      severity: error

    - rule: "forbidden tag patterns must not appear"
      severity: error

  # Structure validation (Markdown file)
  structure:
    - rule: "Single H1 heading only"
      severity: warning

    - rule: "All 20 required sections must be present"
      severity: error

    - rule: "Sections must be numbered 1-20 sequentially"
      severity: error

    - rule: "Document Control must have minimum 6 fields"
      severity: error

    - rule: "File name must match CTR-NNN_name.md format"
      severity: warning

  # Schema validation (YAML file)
  schema:
    - rule: "Companion YAML schema file must exist"
      severity: error

    - rule: "YAML file must be valid OpenAPI 3.x or JSON Schema"
      severity: error

    - rule: "All endpoints must have request and response schemas"
      severity: error

    - rule: "Error responses must be defined"
      severity: warning

  # Content validation
  content:
    - rule: "Context section must include Problem Statement"
      severity: warning

    - rule: "Contract Definition must specify Parties (Provider/Consumer)"
      severity: error

    - rule: "Error Handling must include Error Codes table"
      severity: error

    - rule: "Examples section must include at least one success and one failure example"
      severity: warning

    - rule: "Versioning Strategy must include Version Policy"
      severity: warning

    - rule: "Traceability must reference upstream REQ documents"
      severity: warning

# =============================================================================
# Cross-Reference Requirements (Cumulative Tagging - Layer 9)
# =============================================================================

traceability:
  # Cumulative tagging requirements for Layer 9
  cumulative_tags:
    layer: 9
    required:
      - "@brd: BRD-NNN:NNN"
      - "@prd: PRD-NNN:NNN"
      - "@ears: EARS-NNN:NNN"
      - "@bdd: BDD-NNN:NNN"
      - "@adr: ADR-NNN"
      - "@sys: SYS-NNN:NNN"
      - "@req: REQ-NNN:NNN"
    optional:
      - "@impl: IMPL-NNN:NNN"
    description: "Layer 9 requires 7 upstream artifact tags (8 including optional IMPL)"

  upstream:
    required:
      - type: BRD
        format: "@brd: BRD-NNN:NNN"
        location: "Section 19 or Traceability Tags section"
      - type: PRD
        format: "@prd: PRD-NNN:NNN"
        location: "Section 19 or Traceability Tags section"
      - type: EARS
        format: "@ears: EARS-NNN:NNN"
        location: "Section 19 or Traceability Tags section"
      - type: BDD
        format: "@bdd: BDD-NNN:NNN"
        location: "Section 19 or Traceability Tags section"
      - type: ADR
        format: "@adr: ADR-NNN"
        location: "Section 19 or Traceability Tags section"
      - type: SYS
        format: "@sys: SYS-NNN:NNN"
        location: "Section 19 or Traceability Tags section"
      - type: REQ
        format: "@req: REQ-NNN:NNN"
        location: "Section 19 or Traceability Tags section"
    optional:
      - type: IMPL
        format: "@impl: IMPL-NNN:NNN"
        location: "Section 19 or Traceability Tags section"

  downstream:
    expected:
      - type: SPEC
        format: "SPEC-NNN"
      - type: TASKS
        format: "TASKS-NNN"
      - type: Code
        format: "src/..."

  same_type:
    optional:
      - type: CTR
        format: "@related-ctr: CTR-NNN"
        description: "Related CTR document sharing API context"
      - type: CTR
        format: "@depends-ctr: CTR-NNN"
        description: "Prerequisite CTR document"

# =============================================================================
# Error Messages
# =============================================================================

error_messages:
  E001: "Missing required tag 'ctr'"
  E002: "Missing required tag 'layer-9-artifact'"
  E003: "Invalid document_type: must be 'ctr' or 'template'"
  E004: "Invalid architecture format: use 'architecture_approaches: [value]' array"
  E005: "Forbidden tag pattern detected"
  E006: "Missing required section"
  E007: "Multiple H1 headings detected"
  E008: "Section numbering not sequential (1-20)"
  E009: "Document Control missing required fields"
  E010: "Missing companion YAML schema file"
  E011: "YAML schema is not valid OpenAPI 3.x or JSON Schema"
  E012: "Missing request/response schemas for endpoints"
  E013: "Missing Error Handling section"
  E014: "File name does not match CTR-NNN_name.md format"
  E015: "Contract Definition missing Provider/Consumer specification"
  E016: "Error Codes table missing in Error Handling section"
  W001: "Missing Context Problem Statement"
  W002: "Missing success/failure examples in Examples section"
  W003: "Missing upstream traceability tags (require 7: @brd through @req)"
  W004: "Missing Versioning Strategy Version Policy"
  W005: "Error responses not defined in YAML schema"
  W006: "Missing contract testing requirements in Verification section"
  I001: "Consider adding performance metrics in NFR section"
  I002: "Consider documenting migration strategy in Impact Analysis"
  I003: "Consider adding alternative approaches in Alternatives Considered"
