# =============================================================================
# ðŸ“‹ Document Role: This is a DERIVATIVE of BDD-TEMPLATE.feature
# - Authority: BDD-TEMPLATE.feature is the single source of truth for BDD structure
# - Purpose: Machine-readable validation rules derived from the template
# - On conflict: Defer to BDD-TEMPLATE.feature
# - Note: BDD uses .feature files (Gherkin syntax) only - no YAML template
# =============================================================================
#
# Authority Hierarchy:
# Human Workflow:  Gherkin Feature â†’ BDD Schema (validates .feature) â†’ Validators
# Autopilot:    N/A (BDD not in autopilot workflow)
#
# Schema is DERIVATIVE of Gherkin template (BDD is .feature-only)
#
# BDD Schema Definition v1.1
# Purpose: Define valid metadata structure for BDD feature files
# Usage: Reference by validate_bdd.py for automated validation
# Supports both full and MVP template profiles
#
schema_version: "1.1"
artifact_type: BDD
layer: 4
last_updated: "2026-01-20"

references:
  md_template: "BDD-MVP-TEMPLATE.feature"
  yaml_template: "N/A (BDD is .feature-only, no YAML version)"
  creation_rules: "BDD_CREATION_RULES.md"
  validation_rules: "BDD_VALIDATION_RULES.md"

# =============================================================================
# Profiles (Full vs MVP)
# =============================================================================

profiles:
  default: full
  allowed: [full, mvp]
  mvp:
    enforcement_level: optional
    notes:
      - "MVP BDDs may include a reduced scenario set; completeness checks are warnings."

# =============================================================================
# DOCUMENT AUTHORITY
# =============================================================================
# BDD-TEMPLATE.feature is the PRIMARY AUTHORITY (single source of truth).
# This schema DERIVES validation rules from the template.
#
# Document Hierarchy:
#   1. BDD-TEMPLATE.feature (PRIMARY - defines structure and format)
#   2. BDD_MVP_SCHEMA.yaml (DERIVATIVE - machine-readable validation)
#   3. BDD_CREATION_RULES.md (DERIVATIVE - human guidance)
#   4. BDD_VALIDATION_RULES.md (DERIVATIVE - validation checklist)
#
# CONFLICT RESOLUTION: If this schema conflicts with Template, update schema.

# =============================================================================
# YAML Frontmatter Requirements (Comment-based in .feature files)
# =============================================================================

metadata:
  # Required fields in feature file header comments
  required_custom_fields:
    document_type:
      type: string
      required: true
      allowed_values: ["bdd"]
      description: "Must be 'bdd' - no variations allowed"

    artifact_type:
      type: string
      required: true
      allowed_values: ["BDD"]
      description: "Must be uppercase 'BDD'"

    layer:
      type: integer
      required: true
      allowed_values: [4]
      description: "BDD is always Layer 4 artifact"

    architecture_approaches:
      type: array
      required: true
      allowed_values:
        - ["ai-agent-based"]
        - ["traditional-8layer"]
        - ["ai-agent-based", "traditional-8layer"]
      description: "Must be array format, not 'architecture_approach' string"

    priority:
      type: string
      required: true
      allowed_values: ["primary", "shared", "fallback"]
      description: "Classification tier based on architecture"

    development_status:
      type: string
      required: true
      allowed_values: ["active", "draft", "deprecated", "reference"]
      description: "Current development status"

  # Optional custom_fields
  optional_custom_fields:
    agent_id:
      type: string
      pattern: "^AGENT-\\d{2,}$"
      description: "Required for ai-agent-primary documents"

    source_prd:
      type: string
      pattern: "^PRD-\\d{2,}$"
      description: "Alternative to Source Document in table"

    source_ears:
      type: string
      pattern: "^EARS-\\d{2,}$"
      description: "Reference to source EARS document"

    template_profile:
      type: string
      allowed_values: ["mvp", "full"]
      description: "Template profile hint for validators (e.g., 'mvp')"

  # Required tags
  required_tags:
    - bdd                 # Primary identifier - REQUIRED
    - layer-4-artifact    # Layer identifier - REQUIRED

  # Forbidden tag patterns (will fail validation)
  forbidden_tag_patterns:
    - "^bdd-feature$"           # Use 'bdd' instead
    - "^bdd-scenarios$"         # Use 'bdd' instead
    - "^bdd-document$"          # Use 'bdd' instead
    - "^bdd-\\d{2,}$"            # Don't include document number in tags
    - "^behavior-driven$"       # Use 'bdd' for document_type

# =============================================================================
# Document Structure Requirements
# =============================================================================

structure:
  # Required sections (in order)
  required_sections:
    - pattern: "^Feature:"
      name: "Feature Declaration"
      description: "Feature keyword with descriptive title"

    - pattern: "^\\s+As a"
      name: "User Story - Role"
      description: "As a [role] statement"

    - pattern: "^\\s+I want"
      name: "User Story - Action"
      description: "I want [capability] statement"

    - pattern: "^\\s+So that"
      name: "User Story - Benefit"
      description: "So that [business benefit] statement"

  # Optional but recommended sections
  recommended_sections:
    - pattern: "^\\s+Background:"
      name: "Background"
      description: "Shared setup steps for all scenarios"

  # Document Control (in header comments)
  document_control:
    required_fields:
      - Project Name
      - Document Version
      - Date
      - Document Owner
      - Prepared By
      - Status
      - ADR-Ready Score

    adr_ready_score_format:
      pattern: "âœ… \\d{1,3}% \\(Target: â‰¥90%\\)"
      description: "Format: âœ… NN% (Target: â‰¥90%)"
      example: "âœ… 85% (Target: â‰¥90%)"
      required: true

  # File naming conventions (Section-Based ONLY)
  file_naming:
    description: "Section-based numbering aligned with 02_PRD/BRD standards"
    mandatory_format: "section_based"

    # Three valid patterns (strict enforcement)
    valid_patterns:
      section_only:
        pattern: "^BDD-\\d{2,}\\.\\d+_[a-z0-9_]+\\.feature$"
        description: "Section-only format (primary)"
        example: "BDD-02.14_query_result_filtering.feature"
        use_when: "Standard section file (â‰¤500 lines, â‰¤12 scenarios)"

      subsection:
        pattern: "^BDD-\\d{2,}\\.\\d+\\.\\d{2}_[a-z0-9_]+\\.feature$"
        description: "Subsection format (when section >500 lines)"
        example: "BDD-02.24.01_quality_performance.feature"
        use_when: "Section requires splitting (each subsection â‰¤500 lines)"

      aggregator:
        pattern: "^BDD-\\d{2,}\\.\\d+\\.00_[a-z0-9_]+\\.feature$"
        description: "Aggregator format (redirect stub)"
        example: "BDD-02.12.00_query_graph_traversal.feature"
        use_when: "Organizing multiple subsections under one section"
        requirements:
          - "@redirect tag required"
          - "0 scenarios (no executable tests)"
          - "References to subsections in comments"

    # Prohibited patterns (cause validation ERROR)
    prohibited_patterns:
      part_suffix:
        pattern: "_part\\d+\\.feature$"
        error: "PROHIBITED: _partN suffix not allowed (use subsection format instead)"
        example_bad: "BDD-02_query_part1.feature"
        example_good: "BDD-02.2.01_query_semantic.feature"

      single_file:
        pattern: "^BDD-\\d{2,}_[a-z0-9_]+\\.feature$"
        error: "PROHIBITED: Single-file format (legacy) - use section-based format"
        example_bad: "BDD-02_knowledge_engine.feature"
        example_good: "BDD-02.1_ingest.feature"

      directory_based:
        pattern: "^BDD-\\d{2,}_[a-z0-9_]+/features/"
        error: "PROHIBITED: Legacy features/ subdirectory - use nested suite folder with section-based files"
        example_bad: "BDD-02_knowledge_engine/features/BDD-02_ingest.feature"
        example_good: "BDD-02_knowledge_engine/BDD-02.1_ingest.feature"

    # Section numbering specification
    section_numbering:
      index_file:
        format: "BDD-NN.0_index.md"
        description: "Mandatory index file for each BDD suite"
        example: "BDD-02.0_index.md"
        required: true

      content_sections:
        format: "BDD-NN.SS_{slug}.feature"
        description: "Content section files (SS = 1, 2, 3, ...)"
        example: "BDD-02.1_ingest.feature, BDD-02.2_query.feature"
        numbering: "Sequential from 1 (no gaps)"

      subsections:
        format: "BDD-NN.SS.mm_{slug}.feature"
        description: "Subsections when section >500 lines (mm = 01, 02, ...)"
        example: "BDD-02.3.01_learning_path.feature"
        numbering: "Sequential from 01 within each section"

      aggregators:
        format: "BDD-NN.SS.00_{slug}.feature"
        description: "Optional aggregator/redirect stub (always .00)"
        example: "BDD-02.2.00_query.feature"
        fixed_subsection: "00 (always)"

    # Hard/soft limits
    hard_limits:
      max_file_lines: 600   # Absolute maximum
      soft_file_tokens: 15000  # Soft limit; target range is <15k tokens
      max_scenarios_per_feature: 12
      split_strategy: "When section exceeds 500 lines, create subsections (.SS.mm format)"
      aggregator_strategy: "When many subsections, add aggregator (.SS.00 format)"

    # File organization
    file_organization:
      structure: "nested per-suite (one folder per suite)"
      location: "04_BDD/BDD-NN_{suite_slug}/"
      subdirectories_allowed: true  # suite folder only; no features/ subfolder
      features_subdirectory: "PROHIBITED (legacy format)"
      index_file_location: "inside suite folder (e.g., BDD-02.0_index.md)"

# =============================================================================
# Gherkin Syntax Patterns
# =============================================================================

gherkin_patterns:
  # Valid Gherkin keywords
  keywords:
    feature:
      keyword: "Feature:"
      required: true
      description: "Single Feature declaration per file"

    background:
      keyword: "Background:"
      required: false
      description: "Optional shared context for all scenarios"

    scenario:
      keyword: "Scenario:"
      required: true
      min_count: 1
      description: "At least one Scenario required"

    scenario_outline:
      keyword: "Scenario Outline:"
      required: false
      description: "Data-driven scenario with Examples"

    examples:
      keyword: "Examples:"
      required_with: "Scenario Outline"
      description: "Required when using Scenario Outline"

  # Step keywords
  step_keywords:
    given:
      keyword: "Given"
      description: "Precondition or initial context"
      position: "first_step"

    when:
      keyword: "When"
      description: "Action or trigger"
      position: "after_given"

    then:
      keyword: "Then"
      description: "Expected outcome or verification"
      position: "after_when"

    and:
      keyword: "And"
      description: "Continuation of previous step type"
      position: "any"

    but:
      keyword: "But"
      description: "Negative continuation"
      position: "any"

  # Step order validation
  step_order:
    valid_sequences:
      - ["Given", "When", "Then"]
      - ["Given", "And", "When", "Then"]
      - ["Given", "When", "And", "Then"]
      - ["Given", "When", "Then", "And"]
      - ["Given", "And", "When", "And", "Then", "And"]
    description: "Given must precede When, When must precede Then"

  # Tag patterns
  tag_patterns:
    valid_prefixes:
      - "@primary"
      - "@negative"
      - "@functional"
      - "@quality_attribute"
      - "@acceptance"
      - "@integration"
      - "@edge_case"
      - "@boundary"
      - "@performance"
      - "@security"
      - "@robustness"
      - "@error_handling"
      - "@data_driven"
      - "@failure_recovery"
      - "@reliability"
      - "@alternative"
      - "@end_to_end"
      - "@data_flow"
      - "@latency"
      - "@resilience"
      - "@data_integrity"
      - "@monitoring"
      - "@recovery"

    traceability_tags:
      - pattern: "@brd:\\s*BRD\\.\\d{2,}\\.\\d{2,}"
        description: "BRD traceability tag"
        required: true   # MANDATORY per BDD-TEMPLATE.feature
      - pattern: "@prd:\\s*PRD\\.\\d{2,}\\.\\d{2,}"
        description: "PRD traceability tag"
        required: true   # MANDATORY per BDD-TEMPLATE.feature
      - pattern: "@ears:\\s*EARS\\.\\d{2,}\\.\\d{2,}"
        description: "EARS traceability tag"
        required: true   # MANDATORY per BDD-TEMPLATE.feature
      - pattern: "@requirement:\\[REQ-\\d{2,}\\]"
        description: "REQ traceability tag"
      - pattern: "@adr:\\[ADR-\\d{2,}\\]"
        description: "ADR traceability tag"
      - pattern: "@threshold:\\s*PRD-\\d{2,}:[a-z_]+\\.[a-z_]+(?:\\.[a-z_]+)?"
        description: "Threshold registry reference for quantitative values"
        example: "@threshold: PRD.035.perf.api.p95_latency"
        required: false

# =============================================================================
# Scenario Categories
# =============================================================================

scenario_categories:
  success_path:
    tags: ["@primary", "@functional", "@acceptance"]
    description: "Primary success case scenarios"
    min_count: 1

  alternative_path:
    tags: ["@alternative", "@functional"]
    description: "Valid but non-primary flows"
    min_count: 0

  error_path:
    tags: ["@negative", "@error_handling", "@robustness"]
    description: "Invalid input and error handling"
    recommended_count: 2

  edge_case:
    tags: ["@edge_case", "@boundary"]
    description: "Boundary conditions and limits"
    recommended_count: 1

  data_driven:
    tags: ["@data_driven"]
    description: "Parameterized scenarios with Examples"
    uses: "Scenario Outline"

  integration:
    tags: ["@integration", "@end_to_end"]
    description: "Cross-component integration tests"
    min_count: 0

  quality_attribute:
    tags: ["@quality_attribute", "@performance", "@security", "@reliability"]
    description: "Performance, security, reliability scenarios"
    recommended_count: 1

  failure_recovery:
    tags: ["@failure_recovery", "@resilience"]
    description: "Failure handling and recovery"
    recommended_count: 1

# =============================================================================
# Validation Rules
# =============================================================================

validation_rules:
  # Metadata validation
  metadata:
    - rule: "document_type must be 'bdd'"
      severity: error

    - rule: "architecture_approaches must be array"
      severity: error
      fix: "Change 'architecture_approach: value' to 'architecture_approaches: [value]'"

    - rule: "tags must include 'bdd' and 'layer-4-artifact'"
      severity: error

    - rule: "forbidden tag patterns must not appear"
      severity: error

  # Structure validation
  structure:
    - rule: "Single Feature declaration per file"
      severity: error

    - rule: "Feature must have user story (As a/I want/So that)"
      severity: warning

    - rule: "At least one Scenario or Scenario Outline required"
      severity: error

    - rule: "File name must match section-based patterns (BDD-NN.SS_{slug}.feature | BDD-NN.SS.mm_{slug}.feature | BDD-NN.SS.00_{slug}.feature)"
      severity: warning

  # Gherkin syntax validation
  gherkin:
    - rule: "Each Scenario must have at least one Given step"
      severity: warning

    - rule: "Each Scenario must have at least one When step"
      severity: error

    - rule: "Each Scenario must have at least one Then step"
      severity: error

    - rule: "Step order must follow Given-When-Then sequence"
      severity: error

    - rule: "Scenario Outline must have Examples section"
      severity: error

    - rule: "Examples table must have headers matching placeholders"
      severity: error

  # Content validation
  content:
    - rule: "At least one success path scenario required"
      severity: warning

    - rule: "Scenarios should have descriptive names"
      severity: warning
      pattern: "^[A-Z][a-z].*"

    - rule: "Steps should be written in present tense"
      severity: info

    - rule: "Traceability tags should reference existing artifacts"
      severity: warning

  # Score-status consistency validation
  score_status_consistency:
    rule: "ADR-Ready Score must match document Status"
    mappings:
      - score_range: ">=90"
        required_status: "Approved"
      - score_range: "70-89"
        required_status: "In Review"
      - score_range: "<70"
        required_status: "Draft"
    severity: error
    error_code: "E015"

# =============================================================================
# Cross-Reference Requirements (Cumulative Tagging - Layer 4)
# =============================================================================

traceability:
  # Cumulative tagging requirements for Layer 4
  cumulative_tags:
    layer: 4
    required:
      - "@brd: BRD.NN.EE.SS"
      - "@prd: PRD.NN.EE.SS"
      - "@ears: EARS.NN.EE.SS"
    description: "Layer 4 requires @brd, @prd, @ears tags for full traceability"

  # Cumulative tagging enforcement
  cumulative_tagging:
    enabled: true
    required_upstream_tags:
      - "@brd"
      - "@prd"
      - "@ears"
    enforcement: mandatory
    error_code: "E014"
    error_message: "BDD artifacts require @brd, @prd, and @ears traceability tags"

  upstream:
    required:
      - type: BRD
        format: "@brd: BRD.NN.EE.SS"
        location: "Header comments or scenario tags"
      - type: PRD
        format: "@prd: PRD.NN.EE.SS"
        location: "Header comments or scenario tags"
      - type: EARS
        format: "@ears: EARS.NN.EE.SS"
        location: "Header comments or scenario tags"
    # NOTE: No optional upstream tags - all three (@brd, @prd, @ears) are MANDATORY

  downstream:
    expected:
      - type: SYS
        format: "SYS"   # Generic name only; do not reference numeric IDs until they exist
      - type: REQ
        format: "REQ"   # Generic name only; do not reference numeric IDs until they exist
      - type: SPEC
        format: "SPEC"  # Generic name only; do not reference numeric IDs until they exist

  same_type:
    optional:
      - type: BDD
        format: "@related-bdd: BDD-NN"
        description: "Related BDD feature sharing domain context"
      - type: BDD
        format: "@depends-bdd: BDD-NN"
        description: "Prerequisite BDD feature"

# =============================================================================
# Error Messages
# =============================================================================

error_messages:
  BDD-E001: "Missing required tag 'bdd'"
  BDD-E002: "Missing required tag 'layer-4-artifact'"
  BDD-E003: "Invalid document_type: must be 'bdd'"
  BDD-E004: "Invalid architecture format: use 'architecture_approaches: [value]' array"
  BDD-E005: "Forbidden tag pattern detected"
  BDD-E006: "Missing Feature declaration"
  BDD-E007: "Multiple Feature declarations detected"
  BDD-E008: "Scenario missing required When step"
  BDD-E009: "Scenario missing required Then step"
  BDD-E010: "Invalid step order: Given must precede When, When must precede Then"
  BDD-E011: "Scenario Outline missing Examples section"
  BDD-E012: "Examples table headers do not match placeholders"
  BDD-E013: "File name does not match section-based patterns (BDD-NN.SS_{slug}.feature | BDD-NN.SS.mm_{slug}.feature | BDD-NN.SS.00_{slug}.feature)"
  BDD-E014: "BDD artifacts require @brd, @prd, and @ears traceability tags"
  BDD-E015: "ADR-Ready Score does not match document Status (>=90% requires Approved, 70-89% requires In Review, <70% requires Draft)"
  BDD-W001: "Feature missing user story (As a/I want/So that)"
  BDD-W002: "Scenario missing Given step (context unclear)"
  BDD-W003: "No success path scenarios (@primary) detected"
  BDD-W004: "No error path scenarios (@negative) detected"
  BDD-W005: "Missing upstream traceability tags (@brd, @prd, @ears)"
  BDD-W006: "Scenario name should start with capital letter"
  BDD-W007: "Consider adding Background for shared setup"
  BDD-I001: "Steps should be written in present tense"
  BDD-I002: "Consider adding data-driven scenarios for boundary testing"
