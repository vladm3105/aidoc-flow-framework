# =============================================================================
# ðŸ“‹ Document Role: This is a DERIVATIVE of template(s)
# - Authority:
#   * MD Template: PRD-MVP-TEMPLATE.md (primary for human workflow)
#   * YAML Template: PRD-MVP-TEMPLATE.yaml (primary for autopilot workflow)
# - Purpose: Machine-readable validation rules for both MD and YAML documents
# - On conflict: Defer to respective template (MD or YAML based on document format)
# =============================================================================
#
# Authority Hierarchy:
# Human Workflow:  MD Template â†’ YAML Schema (validates MD) â†’ Validators
# Autopilot:    YAML Template â†’ YAML Schema (validates YAML) â†’ Validators
#
# Schema is DERIVATIVE of both templates (dual-authority)
#
# PRD Schema Definition v1.0
# Purpose: Define valid metadata structure and validation rules for PRD documents
# Usage: Reference by validate_prd.py for automated validation

schema_version: "1.0"
artifact_type: PRD
layer: 2
last_updated: "2026-01-20"

references:
  md_template: "PRD-MVP-TEMPLATE.md"
  yaml_template: "PRD-MVP-TEMPLATE.yaml"
  creation_rules: "PRD_MVP_CREATION_RULES.md"
  validation_rules: "PRD_MVP_VALIDATION_RULES.md"

# =============================================================================
# Profiles (Full vs MVP)
# =============================================================================

profiles:
  default: full
  allowed:
    - full
    - mvp
  mvp:
    enforcement_level: optional
    notes:
      - "MVP PRDs are streamlined; some sections may be condensed or omitted."
      - "Validators should treat missing non-critical sections as warnings."

# =============================================================================
# YAML Frontmatter Requirements
# =============================================================================

metadata:
  # Required fields in custom_fields
  required_custom_fields:
    document_type:
      type: string
      required: true
      allowed_values: ["prd"]
      description: "Must be 'prd' - no variations allowed"

    artifact_type:
      type: string
      required: true
      allowed_values: ["PRD"]
      description: "Must be uppercase 'PRD'"

    layer:
      type: integer
      required: true
      allowed_values: [2]
      description: "PRD is always Layer 2 artifact"

    architecture_approaches:
      type: array
      required: true
      allowed_values:
        - ["ai-agent-based"]
        - ["traditional-8layer"]
        - ["ai-agent-based", "traditional-8layer"]
      description: "Must be array format, not 'architecture_approach' string"

    priority:
      type: string
      required: true
      allowed_values: ["primary", "shared", "fallback"]
      description: "Classification tier based on architecture"

    development_status:
      type: string
      required: true
      allowed_values: ["active", "draft", "deprecated", "reference"]
      description: "Current development status"

  # Optional custom_fields
  optional_custom_fields:
    agent_id:
      type: string
      pattern: "^AGENT-\\d{2,}$"
      description: "Required for ai-agent-primary documents"

    fallback_reference:
      type: string
      pattern: "^PRD-\\d{2,}$|^traditional-8layer$"
      description: "Reference to fallback document"

    primary_alternative:
      type: string
      pattern: "^PRD-\\d{2,}$"
      description: "Reference to primary alternative document"

    template_profile:
      type: string
      allowed_values: ["mvp", "full"]
      description: "Template profile hint for validators (e.g., 'mvp')"

  # Required tags
  required_tags:
    - prd                 # Primary identifier - REQUIRED
    - layer-2-artifact    # Layer identifier - REQUIRED

  # Forbidden tag patterns (will fail validation)
  forbidden_tag_patterns:
    - "^product-prd$"           # Use 'prd' instead
    - "^feature-prd$"           # Use 'prd' instead
    - "^product-requirements$"  # Use 'prd' for document_type
    - "^product_requirements$"  # Use 'prd' for document_type
    - "^prd-\\d{2,}$"            # Don't include document number in tags

# =============================================================================
# Document Structure Requirements
# =============================================================================

structure:
  # Required sections (in order)
  required_sections:
    - pattern: "^# PRD-\\d{2,}:"
      name: "Title (H1)"
      description: "Single H1 with format PRD-NN: Title"

    - pattern: "^## 1\\. Document Control$"
      name: "Document Control"
      description: "Section 1 with metadata table"

    - pattern: "^## 2\\. Executive Summary$"
      name: "Executive Summary"
      description: "Section 2 with business overview"

    - pattern: "^## 3\\. Problem Statement$"
      name: "Problem Statement"
      description: "Section 3 with problem and impact"

    - pattern: "^## 4\\. Target Audience & User Personas$"
      name: "Target Audience & User Personas"
      description: "Section 4 with users and stakeholders"

    - pattern: "^## 5\\. Success Metrics \\(KPIs\\)$"
      name: "Success Metrics (KPIs)"
      description: "Section 5 with KPIs and criteria"

    - pattern: "^## 6\\. Goals & Objectives$"
      name: "Goals & Objectives"
      description: "Section 6 with goals and objectives"

    - pattern: "^## 7\\. Scope & Requirements$"
      name: "Scope & Requirements"
      description: "Section 7 with scope in/out and dependencies"

    - pattern: "^## 8\\. User Stories & User Roles$"
      name: "User Stories & User Roles"
      description: "Section 8 with user stories (PRD-level)"

    - pattern: "^## 9\\. Functional Requirements$"
      name: "Functional Requirements"
      description: "Section 9 with functional capabilities"

    - pattern: "^## 10\\. Customer-Facing Content & Messaging \\(MANDATORY\\)$"
      name: "Customer-Facing Content & Messaging (MANDATORY)"
      description: "Section 10 with customer-visible content"

    - pattern: "^## 11\\. Acceptance Criteria$"
      name: "Acceptance Criteria"
      description: "Section 11 with acceptance criteria"

    - pattern: "^## 12\\. Constraints & Assumptions$"
      name: "Constraints & Assumptions"
      description: "Section 12 with constraints and assumptions"

    - pattern: "^## 13\\. Risk Assessment$"
      name: "Risk Assessment"
      description: "Section 13 with risks"

    - pattern: "^## 14\\. Success Definition$"
      name: "Success Definition"
      description: "Section 14 with go-live and validation"

    - pattern: "^## 15\\. Stakeholders & Communication$"
      name: "Stakeholders & Communication"
      description: "Section 15 with teams and communications"

    - pattern: "^## 16\\. Implementation Approach$"
      name: "Implementation Approach"
      description: "Section 16 with phases and testing strategy"

    - pattern: "^## 17\\. Budget & Resources$"
      name: "Budget & Resources"
      description: "Section 17 with budget and resources"

    - pattern: "^## 18\\. Traceability$"
      name: "Traceability"
      description: "Section 18 with upstream/downstream links"

    - pattern: "^## 19\\. References$"
      name: "References"
      description: "Section 19 with references"

    - pattern: "^## 20\\. EARS Enhancement Appendix$"
      name: "EARS Enhancement Appendix"
      description: "Section 20 with EARS appendix"

    - pattern: "^## 21\\. Quality Assurance & Testing Strategy$"
      name: "Quality Assurance & Testing Strategy"
      description: "Section 21 with QA/testing strategy"

  # Document Control table requirements
  document_control:
    required_fields:
      - Status
      - Version
      - Date Created
      - Last Updated
      - Author
      - Reviewer
      - Approver
      - BRD Reference
      - SYS-Ready Score
      - EARS-Ready Score

    related_brd_format:
      pattern: "^@brd: BRD\\.[0-9]{2,9}\\.[0-9]{2,9}\\.[0-9]{2,9}$"
      description: "Must use @brd: prefix with 4-segment format for traceability (DOC_NUM.ELEM_TYPE.SEQ)"
    # Enforce single upstream BRD reference in Document Control
    related_brd_constraints:
      single_reference_only: true
      notes: "Provide exactly one canonical @brd in Document Control; list additional BRDs in an Upstream Sources subsection if needed."

  # Section numbering rules
  section_numbering:
    start: 1
    format: "## N. Section Title"
    subsection_format: "### N.N Subsection Title"
    no_duplicate_numbers: true
validation_rules:
  # Metadata validation
  metadata:
    - rule: "document_type must be 'prd'"
      severity: error

    - rule: "architecture_approaches must be array"
      severity: error
      fix: "Change 'architecture_approach: value' to 'architecture_approaches: [value]'"

    - rule: "tags must include 'prd' and 'layer-2-artifact'"
      severity: error

    - rule: "forbidden tag patterns must not appear"
      severity: error

  # Structure validation
  structure:
    - rule: "Single H1 heading only"
      severity: warning

    - rule: "Related BRD must use @brd: prefix"
      severity: error

    - rule: "No duplicate section numbers"
      severity: error

    - rule: "Sections must be numbered sequentially"
      severity: warning

  # Content validation
  content:
    - rule: "Feature IDs must use simple 3-digit format (001, 015, 042)"
      severity: warning

    - rule: "Priority must use P0-P3 format"
      severity: warning

    - rule: "Complexity ratings must be Low/Medium/High"
      severity: warning

    - rule: "No numeric downstream references (EARS-#, SYS-#, REQ-#, SPEC-#)"
      severity: error
      fix: "Use generic downstream names (EARS, SYS, REQ, SPEC) until those artifacts exist."

# =============================================================================
# Cross-Reference Requirements
# =============================================================================

traceability:
  upstream:
    required:
      - type: BRD
        format: "@brd: BRD.NN.01.SS"
        location: "Document Control table"
    optional: []

  downstream:
    expected:
      - type: SYS
        format: "SYS"   # Generic name only; do not reference numeric IDs until they exist
      - type: EARS
        format: "EARS"  # Generic name only; do not reference numeric IDs until they exist
      - type: REQ
        format: "REQ"   # Generic name only; do not reference numeric IDs until they exist
      - type: SPEC
        format: "SPEC"  # Generic name only; do not reference numeric IDs until they exist

  lateral:
    format: "@prd: PRD.NN.EE.SS"
    description: "Cross-reference to related PRDs (unified 4-segment format)"

  threshold_references:
    format: "@threshold: PRD.035.category.subcategory"
    description: "Reference to Platform Threshold Registry"

  contract_references:
    format: "@ctr: CTR-NN"
    description: "Reference to data contracts"

# =============================================================================
# Error Messages
# =============================================================================

error_messages:
  PRD-E001: "Missing required tag 'prd'"
  PRD-E002: "Missing required tag 'layer-2-artifact'"
  PRD-E003: "Invalid document_type: must be 'prd'"
  PRD-E004: "Invalid architecture format: use 'architecture_approaches: [value]' array"
  PRD-E005: "Forbidden tag pattern detected"
  PRD-E006: "Related BRD missing @brd: prefix"
  PRD-E007: "Duplicate section number detected"
  PRD-E008: "Multiple H1 headings detected"
  PRD-W001: "Feature ID not using simple 3-digit format (001, 015, 042)"
  PRD-W002: "Priority not using P0-P3 format"
  PRD-W003: "Section numbering not sequential"
  required_sections:
    - pattern: "^# PRD-\\d{2,}:"
      name: "Title (H1)"
      description: "Single H1 with format PRD-NN: Title"

    - pattern: "^## 1\\. Document Control$"
      name: "Document Control"
      description: "Section 1 with metadata table"

    - pattern: "^## 2\\. Executive Summary$"
      name: "Executive Summary"
      description: "Section 2 with business overview"

    - pattern: "^## 3\\. Problem Statement$"
      name: "Problem Statement"
      description: "Section 3 with problem and impact"

    - pattern: "^## 4\\. Target Audience & User Personas$"
      name: "Target Audience & User Personas"
      description: "Section 4 with users and stakeholders"

    - pattern: "^## 5\\. Success Metrics \\(KPIs\\)$"
      name: "Success Metrics (KPIs)"
      description: "Section 5 with KPIs and criteria"

    - pattern: "^## 6\\. Goals & Objectives$"
      name: "Goals & Objectives"
      description: "Section 6 with goals and objectives"

    - pattern: "^## 7\\. Scope & Requirements$"
      name: "Scope & Requirements"
      description: "Section 7 with scope in/out and dependencies"

    - pattern: "^## 8\\. User Stories & User Roles$"
      name: "User Stories & User Roles"
      description: "Section 8 with user stories (PRD-level)"

    - pattern: "^## 9\\. Functional Requirements$"
      name: "Functional Requirements"
      description: "Section 9 with functional capabilities"

    - pattern: "^## 10\\. Customer-Facing Content & Messaging \\(MANDATORY\\)$"
      name: "Customer-Facing Content & Messaging (MANDATORY)"
      description: "Section 10 with customer-visible content"

    - pattern: "^## 11\\. Acceptance Criteria$"
      name: "Acceptance Criteria"
      description: "Section 11 with acceptance criteria"

    - pattern: "^## 12\\. Constraints & Assumptions$"
      name: "Constraints & Assumptions"
      description: "Section 12 with constraints and assumptions"

    - pattern: "^## 13\\. Risk Assessment$"
      name: "Risk Assessment"
      description: "Section 13 with risks"

    - pattern: "^## 14\\. Success Definition$"
      name: "Success Definition"
      description: "Section 14 with go-live and validation"

    - pattern: "^## 15\\. Stakeholders & Communication$"
      name: "Stakeholders & Communication"
      description: "Section 15 with teams and communications"

    - pattern: "^## 16\\. Implementation Approach$"
      name: "Implementation Approach"
      description: "Section 16 with phases and testing strategy"

    - pattern: "^## 17\\. Budget & Resources$"
      name: "Budget & Resources"
      description: "Section 17 with budget and resources"

    - pattern: "^## 18\\. Traceability$"
      name: "Traceability"
      description: "Section 18 with upstream/downstream links"

    - pattern: "^## 19\\. References$"
      name: "References"
      description: "Section 19 with references"

    - pattern: "^## 20\\. EARS Enhancement Appendix$"
      name: "EARS Enhancement Appendix"
      description: "Section 20 with EARS appendix"

    - pattern: "^## 21\\. Quality Assurance & Testing Strategy$"
      name: "Quality Assurance & Testing Strategy"
      description: "Section 21 with QA/testing strategy"
