# ITEST_MVP_SCHEMA.yaml
# JSON Schema for Integration Test Specification validation
# Version: 1.0

$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://ai-dev-flow/schemas/itest-mvp-v1.0.json"
title: "ITEST MVP Schema"
description: "Validation schema for Integration Test Specification documents"
type: object

required:
  - metadata
  - document_control
  - test_scope
  - test_case_index
  - test_case_details
  - ctr_coverage_matrix
  - traceability

properties:
  metadata:
    type: object
    required:
      - document_id
      - title
      - artifact_type
      - layer
      - test_type_code
    properties:
      document_id:
        type: string
        pattern: "^ITEST-\\d{2,}$"
      title:
        type: string
        minLength: 10
      artifact_type:
        type: string
        const: "ITEST"
      layer:
        type: integer
        const: 10
      test_type_code:
        type: integer
        const: 41

  document_control:
    type: object
    required:
      - status
      - version
      - integration_scope
      - ctr_reference
      - coverage_target
    properties:
      status:
        type: string
        enum: ["Draft", "Review", "Approved", "Implemented"]
      version:
        type: string
        pattern: "^\\d+\\.\\d+\\.\\d+$"
      integration_scope:
        type: string
        minLength: 1
      ctr_reference:
        type: string
        pattern: "^CTR-\\d{2,}$"
      sys_reference:
        type: string
        pattern: "^SYS\\.\\d{2,}\\.\\d{2}\\.\\d{2,}$"
      coverage_target:
        type: integer
        minimum: 75
        maximum: 100

  test_scope:
    type: object
    required:
      - components_under_test
      - integration_points
    properties:
      components_under_test:
        type: array
        minItems: 2
        items:
          type: object
          required:
            - component
            - role
          properties:
            component:
              type: string
            role:
              type: string
            interface:
              type: string

      integration_points:
        type: array
        minItems: 1
        items:
          type: object
          required:
            - id
            - source
            - target
            - protocol
          properties:
            id:
              type: string
            source:
              type: string
            target:
              type: string
            protocol:
              type: string
            ctr_reference:
              type: string
            sys_reference:
              type: string

  test_case_index:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - id
        - name
        - components
        - priority
      properties:
        id:
          type: string
          pattern: "^TSPEC\\.\\d{2,}\\.41\\.\\d{2,}$"
        name:
          type: string
        components:
          type: string
        ctr_coverage:
          type: string
        priority:
          type: string
          enum: ["P1", "P2", "P3"]

  test_case_details:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - id
        - name
        - traceability
        - contract_compliance
        - side_effects
      properties:
        id:
          type: string
          pattern: "^TSPEC\\.\\d{2,}\\.41\\.\\d{2,}$"
        name:
          type: string
        components:
          type: string
        traceability:
          type: object
          required:
            - ctr
            - spec
          properties:
            ctr:
              type: string
            ctr_endpoint:
              type: string
            sys:
              type: string
            spec:
              type: string
        contract_compliance:
          type: array
          minItems: 2
          items:
            type: object
            required:
              - aspect
              - expected
              - validation
        sequence_diagram:
          type: string
        side_effects:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - effect
              - verification

  ctr_coverage_matrix:
    type: array
    minItems: 1
    items:
      type: object
      required:
        - endpoint
        - test_ids
        - covered
      properties:
        endpoint:
          type: string
        method:
          type: string
          enum: ["GET", "POST", "PUT", "PATCH", "DELETE"]
        test_ids:
          type: array
          items:
            type: string
        covered:
          type: boolean

  traceability:
    type: object
    required:
      - upstream
    properties:
      upstream:
        type: array
        minItems: 3
        items:
          type: object
          required:
            - tag
            - reference
          properties:
            tag:
              type: string
              enum: ["@ctr", "@sys", "@spec", "@req", "@brd", "@prd"]
            reference:
              type: string
            description:
              type: string
